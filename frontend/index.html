<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CosWatch | Tactical Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script type="text/javascript">
   (function(){
      emailjs.init("YOUR_PUBLIC_KEY");
   })();
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-deep: #020408;
            --glass-panel: rgba(10, 15, 30, 0.75);
            --neon-cyan: #00f3ff;
            --hazard-red: #ff3b3b;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: white;
            margin: 0;
            overflow: hidden;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .syne { font-family: 'Syne', sans-serif; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .glass-panel {
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .mission-row:hover {
            background: rgba(0, 243, 255, 0.1);
            border-left: 2px solid var(--neon-cyan);
        }
        .mission-row.active {
            background: linear-gradient(90deg, rgba(0, 243, 255, 0.2) 0%, transparent 100%);
            border-left: 3px solid var(--neon-cyan);
        }
        .radar-sweep { animation: radar-spin 4s linear infinite; }
        @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #auth-overlay { transition: opacity 0.8s ease; }
        body.locked main { filter: blur(15px); pointer-events: none; }
        /* --- 2D DATA VIEW (Tactical Grid) --- */
        #data-view-container {
            display: none; /* Hidden by default */
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a24 0%, #000000 100%);
            padding: 80px 40px; /* Space for UI panel */
            overflow-y: auto;
            z-index: 5;
            box-sizing: border-box;
            text-align: center;
        }

        .asteroid-2d {
            display: inline-block;
            margin: 20px;
            border-radius: 50%;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            cursor: pointer;
        }

        .asteroid-2d:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        /* The "Max Diameter" (Outer Shell) */
        .asteroid-shell {
            width: 100%; height: 100%;
            border-radius: 50%;
            opacity: 0.3;
            border: 1px dashed rgba(255,255,255,0.3);
        }

        /* The "Min Diameter" (Solid Core) */
        .asteroid-core {
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }

        /* HAZARDOUS STYLES */
        .hazard-true .asteroid-shell {
            background-color: rgba(255, 0, 0, 0.1);
            border-color: #ff3333;
            box-shadow: 0 0 20px #ff0000;
        }
        .hazard-true .asteroid-core {
            background: linear-gradient(135deg, #800000, #ff0000);
            border: 1px solid #ff9999;
        }
        /* --- UPGRADED 2D VIEW STYLES --- */
        .analysis-header {
            max-width: 800px;
            margin: 0 auto 40px auto;
            text-align: left;
            border-left: 2px solid var(--neon-cyan);
            padding-left: 20px;
            background: linear-gradient(90deg, rgba(0, 243, 255, 0.1) 0%, transparent 100%);
        }

        .filter-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            color: #8899a6;
            padding: 8px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .filter-btn:hover, .filter-btn.active {
            background: rgba(0, 243, 255, 0.2);
            border-color: var(--neon-cyan);
            color: white;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }

        /* SPEED TAILS */
        .velocity-tail {
            position: absolute;
            top: 50%; left: 50%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5));
            transform-origin: left center;
            z-index: -1;
        }

        /* IMPACT INFO BOX */
        .impact-info {
            font-size: 9px;
            color: #aaa;
            margin-top: 4px;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 4px;
        }
        
        /* SCALE REFERENCE MARKER */
        .scale-ref {
            position: absolute;
            bottom: 10px; right: 10px;
            height: 100px; width: 2px;
            background: white;
            display: none; /* Toggled via JS */
        }
        .scale-ref::after {
            content: "EIFFEL TOWER (330m)";
            position: absolute;
            bottom: 0; right: 5px;
            font-size: 9px;
            white-space: nowrap;
            color: white;
        }

        /* SAFE STYLES */
        .hazard-false .asteroid-shell {
            background-color: rgba(0, 200, 255, 0.05);
            border-color: #00ccff;
            box-shadow: 0 0 10px #00ccff;
        }
        .hazard-false .asteroid-core {
            background: linear-gradient(135deg, #333344, #556677);
            border: 1px solid #8899aa;
        }

        /* INFO LABEL (Appears on Hover) */
        .asteroid-label {
            position: absolute;
            bottom: -30px; left: 50%;
            transform: translateX(-50%);
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            background: rgba(0,0,0,0.8);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .asteroid-2d:hover .asteroid-label {
            opacity: 1;
        }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden locked">

    <div id="auth-overlay" class="fixed inset-0 z-[999] bg-black/90 backdrop-blur-xl flex items-center justify-center">
        <div class="w-[400px] border border-white/10 bg-black/80 p-8 rounded-xl shadow-[0_0_50px_rgba(0,255,255,0.1)] relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent"></div>
            
            <div class="text-center mb-8">
                <h1 class="syne text-3xl uppercase tracking-widest text-white mb-2">Cosmic<span class="text-cyan-500">Watch</span></h1>
                <p class="mono text-[10px] text-slate-500 uppercase tracking-[0.2em]">Restricted Access // Sector 7</p>
            </div>

            <div class="space-y-4">
                <div class="space-y-2">
                    <input id="auth-email" type="email" placeholder="OPERATOR ID (EMAIL)" class="w-full bg-white/5 border border-white/10 p-3 text-xs mono text-white focus:border-cyan-500 outline-none transition-colors">
                    <input id="auth-pass" type="password" placeholder="ACCESS KEY" class="w-full bg-white/5 border border-white/10 p-3 text-xs mono text-white focus:border-cyan-500 outline-none transition-colors">
                </div>
                
                <div id="auth-error" class="hidden text-red-500 text-[10px] mono text-center uppercase tracking-widest animate-pulse">
                    INVALID CREDENTIALS
                </div>
                <div id="signup-msg" class="hidden text-cyan-400 text-[10px] mono text-center uppercase tracking-widest"></div>

                <div class="grid grid-cols-2 gap-3">
                    <button id="login-btn" onclick="handleLogin()" class="bg-cyan-600 hover:bg-cyan-500 text-white py-3 text-xs font-bold uppercase tracking-widest transition-all">
                        Login
                    </button>
                    <button id="signup-btn" onclick="handleSignUp()" class="border border-white/20 hover:bg-white/5 text-slate-300 py-3 text-xs font-bold uppercase tracking-widest transition-all">
                        Sign Up
                    </button>
                </div>

                <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div><span class="relative bg-black px-2 text-[9px] text-slate-500 mono uppercase block text-center">OR</span></div>
                
                <button onclick="handleGuest()" class="w-full py-2 text-[10px] text-slate-500 hover:text-cyan-400 mono uppercase tracking-widest transition-colors">
                    Initialize Guest Protocol
                </button>
            </div>
        </div>
    </div>

    <aside class="w-[380px] flex-shrink-0 bg-black/90 border-r border-white/10 flex flex-col z-20 relative">
        <div class="p-6 border-b border-white/10 bg-gradient-to-r from-slate-900 to-black">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_lime]"></div>
                <span class="text-[10px] mono uppercase tracking-[0.2em] text-slate-400">Live Telemetry</span>
            </div>
            <h1 class="syne text-3xl uppercase tracking-tighter leading-none">
                Cosmic<br/><span class="text-cyan-400">Watch</span>
            </h1>
            
            <div class="grid grid-cols-2 gap-2 mt-6">
                <div class="bg-white/5 p-3 rounded border border-white/5">
                    <span class="block text-[9px] mono text-slate-500 uppercase">Tracked Objects</span>
                    <span id="stat-objects" class="text-2xl font-bold mono">--</span>
                </div>
                <div class="bg-white/5 p-3 rounded border border-white/5">
                    <span class="block text-[9px] mono text-slate-500 uppercase">Highest Risk</span>
                    <span id="stat-risk" class="text-2xl font-bold mono text-yellow-500">--%</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 bg-black z-10 text-[10px] mono uppercase text-slate-500 border-b border-white/10">
                    <tr>
                        <th class="p-3 pl-6 font-normal">Designation</th>
                        <th class="p-3 pr-6 font-normal text-right">Hazard %</th>
                    </tr>
                </thead>
                <tbody id="neo-table-body"></tbody>
            </table>
        </div>

        <div class="p-3 border-t border-white/10 bg-black text-[10px] mono text-slate-600 flex justify-between items-center">
            <span id="status-indicator">AWAITING AUTH...</span>
            <span id="user-tier-badge" class="px-2 py-0.5 rounded bg-slate-800 text-slate-400">LOCKED</span>
        </div>
    </aside>

    <main class="flex-1 relative bg-black">
        <div id="visualization-container" class="absolute inset-0 z-0"></div>
        <div id="data-view-container"></div>

        <div class="absolute top-5 right-5 flex gap-2 z-[9999] pointer-events-auto">
    
    <div class="relative group">
        <button class="glass-panel px-3 py-2 text-cyan-400 hover:bg-cyan-400/10 border border-cyan-400/30 transition flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        </button>
        <span id="notif-badge" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-sm hidden border border-black">0</span>
    </div>

    <button onclick="document.getElementById('scientific-doc').classList.remove('hidden')" 
            class="glass-panel px-4 py-2 text-cyan-400 text-xs font-bold tracking-widest hover:bg-cyan-400/10 border border-cyan-400/30 hover:border-cyan-400 transition-all flex items-center gap-2 cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        DOCS
    </button>

    <button onclick="resetCamera('solar')" 
            class="glass-panel px-4 py-2 text-white text-xs font-bold tracking-widest hover:bg-white/10 border border-white/10 hover:border-white transition cursor-pointer flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        SYSTEM VIEW
    </button>

    <button onclick="resetCamera('earth')" 
            class="glass-panel px-4 py-2 text-green-400 text-xs font-bold tracking-widest hover:bg-green-400/10 border border-green-400/30 hover:border-green-400 transition cursor-pointer flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.54 15H17a2 2 0 0 0-2 2v4.54"></path><path d="M7 3.34V5a3 3 0 0 0 3 3v0a2 2 0 0 1 2 2v0c0 1.1.9 2 2 2v0a2 2 0 0 0 2-2v0c0-1.1.9-2 2-2h3.17"></path><path d="M11 21.95V18a2 2 0 0 0-2-2v0a2 2 0 0 1-2-2v-1a2 2 0 0 0-2-2H2.05"></path><circle cx="12" cy="12" r="10"></circle></svg>
        EARTH VIEW
    </button>

</div>
            <div class="flex flex-col items-end pointer-events-auto gap-4">
                 <button onclick="fetchNEOData()" class="text-cyan-500 hover:text-white transition-colors bg-white/5 p-2 rounded-full border border-white/10 hover:bg-cyan-500/20">
                    <i data-lucide="refresh-cw" size="18"></i>
                </button>
                <button id="admin-btn" onclick="openAdminPrompt()" class="hidden px-4 py-2 bg-red-500/10 border border-red-500/50 text-red-400 mono text-[10px] uppercase tracking-widest hover:bg-red-500 hover:text-white transition-all">
                    <i data-lucide="shield-alert" size="14" class="inline mr-1"></i> Admin Panel
                </button>
            </div>
        </div>

        <div id="detail-card" class="absolute top-24 left-8 w-[400px] glass-panel rounded-xl p-6 hidden z-20 pointer-events-auto transform transition-all duration-500 translate-x-[-20px] opacity-0">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span id="detail-id" class="text-[10px] mono text-cyan-500 uppercase tracking-widest">NEO-ID</span>
                        <div id="detail-hazard-badge" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Analyzing</div>
                    </div>
                    <h2 id="detail-name" class="syne text-4xl text-white leading-none tracking-tight">Object</h2>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="space-y-1">
                    <span class="text-[9px] mono text-slate-500 uppercase">Diameter</span>
                    <p id="detail-size" class="text-xl font-mono text-white">---</p>
                </div>
                <div class="space-y-1">
                    <span class="text-[9px] mono text-slate-500 uppercase">Velocity</span>
                    <p id="detail-vel" class="text-xl font-mono text-cyan-400">---</p>
                </div>
                <div class="space-y-1 col-span-2">
                    <span class="text-[9px] mono text-slate-500 uppercase">Miss Distance</span>
                    <p id="detail-dist" class="text-2xl font-mono text-white">---</p>
                </div>
            </div>

            <div class="mb-4 bg-white/5 p-3 rounded border border-white/5">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-[10px] mono text-slate-400 uppercase tracking-widest">Impact Probability</span>
                    <span id="detail-risk-val" class="text-xl font-bold text-white">0%</span>
                </div>
                <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                    <div id="detail-risk-bar" class="h-full bg-cyan-500 transition-all duration-1000 w-0"></div>
                </div>
            </div>
        </div>

        <div class="absolute top-24 right-8 z-20 pointer-events-auto flex flex-col items-center gap-2">
            <div class="relative w-72 h-72 rounded-full border border-white/20 bg-black/60 backdrop-blur-md flex items-center justify-center shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden">
                <div class="absolute inset-0 border rounded-full border-white/10 scale-75"></div>
                <div class="absolute inset-0 border rounded-full border-white/5 scale-50"></div>
                <div class="absolute w-full h-[1px] bg-white/10 top-1/2"></div>
                <div class="absolute h-full w-[1px] bg-white/10 left-1/2"></div>
                <div class="absolute w-1/2 h-1/2 top-0 left-0 origin-bottom-right radar-sweep border-r border-cyan-500/30 bg-gradient-to-l from-cyan-500/10 to-transparent"></div>
                <div id="radar-blips" class="absolute inset-0 w-full h-full"></div>
                <div class="absolute w-2 h-2 bg-cyan-400 rounded-full shadow-[0_0_10px_cyan] z-10"></div>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></span>
                <span class="text-[9px] mono text-cyan-400/80 uppercase tracking-widest">Active Scan // 50M KM</span>
            </div>
        </div>

    </main>

    <script>
    // --- 1. CONFIGURATION ---
    const SB_URL = "https://toamgacouwrwtibzbwyo.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvYW1nYWNvdXdyd3RpYnpid3lvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MzMwMzIsImV4cCI6MjA4NjAwOTAzMn0.RF1k9QJG6sL6N1CBwPfHH-Zv0Jou1Lh3202dHolkmL0";
    
    // SAFE VARIABLE NAME: sbClient
    const sbClient = supabase.createClient(SB_URL, SB_KEY);
    
    const API_URL = 'https://coswatch-production.up.railway.app';
    const MOCK_DATA = [
        { name: "99942 Apophis", hazardous: true, velocity_kph: 30720, miss_distance_km: 31000, risk_score: 96, estimated_diameter: { meters: { estimated_diameter_max: 370 } } },
        { name: "2024 FG3", hazardous: false, velocity_kph: 15400, miss_distance_km: 12000000, risk_score: 5, estimated_diameter: { meters: { estimated_diameter_max: 22 } } }
    ];

    let scene, camera, renderer, controls;
    let asteroids = [];
    let followedMesh = null;
    let planets = []; 
    let globalData = []; 
    let raycaster = new THREE.Raycaster();
    let mouse = new THREE.Vector2();
    // Add this with your other global variables
    let followOffset = new THREE.Vector3();
    let currentUser = null;

    // --- 2. AUTH FLOW ---
    async function handleLogin() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        const btn = document.getElementById('login-btn');
        const err = document.getElementById('auth-error');

        if (!email || !password) return;

        btn.innerText = "VERIFYING...";
        btn.disabled = true;
        err.classList.add('hidden');

        const { data, error } = await sbClient.auth.signInWithPassword({ email, password });

        if (error) {
            err.innerText = error.message.toUpperCase();
            err.classList.remove('hidden');
            btn.innerText = "LOGIN";
            btn.disabled = false;
        } else {
            await syncUserWithBackend(data.user.id);
        }
    }
    // --- NEW: BLUE POINTER ON EARTH ---
    function addEarthPointer(lat, lon) {
        const earthObj = planets.find(p => p.name === "Earth");
        if (!earthObj) return;

        // Earth is at earthObj.mesh.position (which is x=40, y=0, z=0 usually)
        // But the mesh itself is rotated. We need to attach the pointer TO the Earth mesh
        // so it spins WITH the Earth.

        // 1. The Marker Geometry (A thin glowing stick)
        const geometry = new THREE.CylinderGeometry(0.02, 0.02, 0.8, 8);
        const material = new THREE.MeshBasicMaterial({ 
            color: 0x00f3ff, // Neon Blue
            transparent: true,
            opacity: 0.8
        });
        
        const pointer = new THREE.Mesh(geometry, material);
        
        // 2. Calculate Position on Surface (Radius is 1.6)
        // We use lat/lon 0,0 for now, or whatever you pass
        const pos = getEarthPosition(lat, lon, 1.6); // 1.6 is Earth's radius in your code
        
        pointer.position.copy(pos);
        
        // 3. Orient the pointer to stick OUT of the earth
        pointer.lookAt(new THREE.Vector3(0,0,0)); // Look at center of earth
        pointer.rotateX(Math.PI / 2); // Rotate 90deg so the cylinder points out
        
        // 4. Add to Earth MESH (so it rotates with the planet)
        earthObj.mesh.add(pointer);
        
        // 5. Add a glowing ring at the base
        const ringGeo = new THREE.RingGeometry(0.04, 0.06, 32);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0x00f3ff, side: THREE.DoubleSide });
        const ring = new THREE.Mesh(ringGeo, ringMat);
        ring.position.copy(pos.clone().multiplyScalar(1.01)); // Slightly above surface
        ring.lookAt(new THREE.Vector3(0,0,0));
        earthObj.mesh.add(ring);
    }

    async function handleSignUp() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        const btn = document.getElementById('signup-btn');
        const msg = document.getElementById('signup-msg');
        const err = document.getElementById('auth-error');

        if(!email || !password) {
            err.innerText = "ENTER CREDENTIALS";
            err.classList.remove('hidden');
            return;
        }

        btn.innerText = "CREATING...";
        btn.disabled = true;

        const { data, error } = await sbClient.auth.signUp({ email, password });

        if (error) {
            err.innerText = error.message.toUpperCase();
            err.classList.remove('hidden');
            btn.innerText = "SIGN UP";
            btn.disabled = false;
        } else {
            msg.innerText = "ACCOUNT CREATED. LOGGING IN...";
            msg.classList.remove('hidden');
            if(data.session) {
                await syncUserWithBackend(data.user.id);
            } else {
                msg.innerText = "CONFIRM EMAIL TO CONTINUE";
            }
        }
    }

    async function syncUserWithBackend(userId) {
        try {
            console.log("Initializing User on Backend:", userId);
            const response = await fetch(`${API_URL}/user/init`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });
            
            if(!response.ok) throw new Error("Backend handshake failed");
            
            const result = await response.json();
            const tier = result.tier || 'researcher'; 
            
            unlockDashboard(tier.toUpperCase());
        } catch (e) {
            console.error("Sync Error:", e);
            unlockDashboard('RESEARCHER (OFFLINE)'); 
        }
    }

    function handleGuest() {
        unlockDashboard('GUEST');
    }

    function unlockDashboard(role) {
        const overlay = document.getElementById('auth-overlay');
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 800);
        document.body.classList.remove('locked');

        document.getElementById('status-indicator').innerHTML = `<span class="text-cyan-400 font-bold animate-pulse">‚óè SYSTEM ONLINE</span>`;
        document.getElementById('user-tier-badge').innerText = role;

        if (role === 'ADMIN') document.getElementById('admin-btn').classList.remove('hidden');

        init3D();
        fetchNEOData();
    }

    // --- 3. DATA LOGIC ---
    // --- 3. DATA LOGIC (DEBUG MODE) ---
    // GLOBAL FLAG: Prevents spamming alerts every refresh
let emailSentSession = false; 

async function fetchNEOData() {
    console.group("üöÄ STARTING NEO DATA FETCH");
    console.time("Fetch Duration");

    try {
        const url = `${API_URL}/neo/feed`;
        console.log(`üì° Dialing Backend: ${url}`);

        const res = await fetch(url);
        
        console.log(`DATA STATUS: ${res.status} ${res.statusText}`);
        
        if (!res.ok) {
            throw new Error(`Server responded with ${res.status}`);
        }

        const rawData = await res.json();
        console.log("üì¶ Raw Payload Received:", rawData);

        // CHECK: Is it an array (our processed list) or NASA raw JSON?
        let processed = [];
        
        if (Array.isArray(rawData)) {
            console.log(`‚úÖ Backend returned Clean Array of ${rawData.length} objects`);
            processed = rawData;
        } else if (rawData.near_earth_objects) {
            console.warn("‚ö†Ô∏è Backend returned RAW NASA JSON (Not Processed). Processing manually...");
            Object.values(rawData.near_earth_objects).forEach(dayList => {
                processed = processed.concat(dayList);
            });
        } else {
            console.error("‚ùå Data format unrecognized:", rawData);
        }

        // FALLBACK CHECK
        if (processed.length === 0) {
            console.warn("‚ö†Ô∏è Data empty. Switching to Emergency Mock Data.");
            processed = MOCK_DATA;
        }

        // LOG THE FIRST ITEM TO VERIFY STRUCTURE
        if (processed.length > 0) {
            console.log("üßê Inspecting First Object:", processed[0]);
            if (!processed[0].estimated_diameter && !processed[0].size_m) {
                console.error("‚ùå CRITICAL: 'estimated_diameter' or 'size_m' missing! Asteroids will be invisible.");
            }
        }

        // --- MAP DATA TO APP FORMAT ---
        globalData = processed.map((obj, i) => {
            // Diameter Logic
            let diam = 50; 
            let minDiam = 30;

            if (obj.size_m) {
                diam = obj.size_m;
                minDiam = diam * 0.7;
            }
            else if (obj.estimated_diameter?.meters?.estimated_diameter_max) {
                diam = obj.estimated_diameter.meters.estimated_diameter_max;
                minDiam = obj.estimated_diameter.meters.estimated_diameter_min;
            }

            let vel = parseFloat(obj.velocity_kph) || 
                      parseFloat(obj.close_approach_data?.[0]?.relative_velocity?.kilometers_per_hour) || 0;
            
            let dist = parseFloat(obj.miss_distance_km) || 
                       parseFloat(obj.close_approach_data?.[0]?.miss_distance?.kilometers) || 0;
            
            // Risk Calculation (If backend doesn't provide it)
            const isHazardous = obj.hazardous || obj.is_potentially_hazardous_asteroid || false;
            let risk = obj.risk_score;
            if (!risk) {
                // Mock risk calculation for realism
                if (isHazardous) risk = 85 + (Math.random() * 14); // 85-99%
                else risk = Math.random() * 40; // 0-40%
            }

            return {
                id: obj.id || `neo-${i}`,
                name: obj.name || "Unknown",
                velocity_kph: vel,
                miss_distance_km: dist,
                size_m: diam,
                raw_diameter_min: minDiam,
                raw_diameter_max: diam,
                hazardous: isHazardous,
                risk_score: risk
            };
        });

        console.log(`‚úÖ Final Parsed Data: ${globalData.length} objects ready for 3D.`);
        
        // --- UI & 3D UPDATES ---
        globalData.sort((a, b) => b.risk_score - a.risk_score);
        updateUI(globalData);
        updateAsteroids(globalData); 
        updateRadar(globalData);

        // --- üö® NOTIFICATION SYSTEM TRIGGER ---
        // This checks if any asteroid is dangerous and alerts the user
        checkDefenseStatus(globalData);

    } catch (e) {
        console.error("üö® FATAL FETCH ERROR:", e);
        console.warn("‚ö†Ô∏è System Offline. Loading Simulation Data.");
        
        // LOAD MOCK DATA
        globalData = MOCK_DATA.map((obj, i) => ({
            id: `mock-${i}`,
            name: obj.name,
            velocity_kph: obj.velocity_kph,
            miss_distance_km: obj.miss_distance_km,
            size_m: obj.estimated_diameter.meters.estimated_diameter_max,
            hazardous: obj.hazardous,
            risk_score: obj.risk_score
        }));
        updateUI(globalData);
        updateAsteroids(globalData);
        updateRadar(globalData);
    }
    
    console.timeEnd("Fetch Duration");
    console.groupEnd();
}

// --- DEFENSE STATUS NOTIFICATION HELPER ---
// GLOBAL VARIABLE FOR COUNT
let totalNotifications = 0;

function checkDefenseStatus(data) {
    if (emailSentSession) return; 

    const RISK_LIMIT = 80; 
    const threats = data.filter(obj => obj.risk_score > RISK_LIMIT);

    if (threats.length > 0) {
        console.warn(`‚ö†Ô∏è SYSTEM ALERT: ${threats.length} HIGH RISK OBJECTS DETECTED.`);
        
        // --- 1. UPDATE UI COUNTER ---
        totalNotifications += threats.length; // Add number of threats found
        
        const badge = document.getElementById('notif-badge');
        if(badge) {
            badge.innerText = totalNotifications;
            badge.classList.remove('hidden'); // Show the badge
            badge.classList.add('animate-ping'); // Pulse effect
            
            // Remove pulse after 1s so it doesn't look annoying
            setTimeout(() => badge.classList.remove('animate-ping'), 1000);
        }

        // --- 2. BROWSER NOTIFICATION (Existing) ---
        if ("Notification" in window) {
            if (Notification.permission === "granted") {
                new Notification("‚ö†Ô∏è C-0-MOS DEFENSE ALERT", {
                    body: `CRITICAL: ${threats.length} Hazardous Objects Detected.`,
                    icon: "https://cdn-icons-png.flaticon.com/512/564/564619.png"
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        emailSentSession = true; 
    }
}
    function updateUI(data) {
        document.getElementById('stat-objects').innerText = data.length;
        document.getElementById('stat-risk').innerText = Math.max(...data.map(d=>d.risk_score||0)) + "%";
        document.getElementById('neo-table-body').innerHTML = data.map(neo => `
            <tr onclick="handleObjectClick('${neo.id}')" id="row-${neo.id}" class="mission-row cursor-pointer transition-colors border-b border-white/5">
                <td class="p-3 pl-6">
                    <div class="flex flex-col">
                        <span class="font-bold text-sm text-slate-200">${neo.name}</span>
                        <span class="text-[9px] mono text-slate-600 tracking-widest">ID: ${neo.id.split('-')[1]}</span>
                    </div>
                </td>
                <td class="p-3 pr-6 text-right">
                    <span class="mono text-xs font-bold ${neo.risk_score >= 70 ? 'text-red-500' : 'text-cyan-500'}">${neo.risk_score}%</span>
                </td>
            </tr>
        `).join('');
    }
    // --- HELPER: GENERATE GLOW TEXTURE (No more 404s) ---
// Define this helper function at the top of your script or outside init3D
function createGlowTexture() {
    const canvas = document.createElement('canvas');
    canvas.width = 32; canvas.height = 32;
    const context = canvas.getContext('2d');
    const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
    gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
    gradient.addColorStop(0.2, 'rgba(255, 170, 0, 1)');
    gradient.addColorStop(0.4, 'rgba(255, 100, 0, 0.5)');
    gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
    context.fillStyle = gradient;
    context.fillRect(0, 0, 32, 32);
    return new THREE.CanvasTexture(canvas);
}

// Then use it in your init3D function:
const spriteMaterial = new THREE.SpriteMaterial({ 
    map: createGlowTexture(), 
    color: 0xffaa00, 
    transparent: true, 
    blending: THREE.AdditiveBlending 
});
    // --- HELPER: Lat/Lon to 3D Position ---
    function getEarthPosition(lat, lon, radius) {
        const phi = (90 - lat) * (Math.PI / 180);
        const theta = (lon + 180) * (Math.PI / 180);
        
        const x = -(radius * Math.sin(phi) * Math.cos(theta));
        const z = (radius * Math.sin(phi) * Math.sin(theta));
        const y = (radius * Math.cos(phi));
        
        return new THREE.Vector3(x, y, z);
    }

    // --- 4. 3D SOLAR SYSTEM ---
    function init3D() {
        const container = document.getElementById('visualization-container');
        if (container.children.length > 0) return; 

        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020205, 0.002); 

        camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 20000); 
        camera.position.set(0, 100, 150); 
        
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping; 
        renderer.toneMappingExposure = 1.3; 
        container.appendChild(renderer.domElement);
        
        // --- 1. UPDATED CONTROLS FOR SMOOTH FOLLOWING ---
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;  // Critical for the smooth "spring" feel
        controls.dampingFactor = 0.05;
        controls.enablePan = false;     // Disable panning so you don't lose the target
        controls.minDistance = 2;       // Allow getting very close
        controls.maxDistance = 500;
        
        const ambientLight = new THREE.AmbientLight(0x606080, 1.2); 
        scene.add(ambientLight);

        const sunLight = new THREE.PointLight(0xffaa00, 5.0, 3000);
        sunLight.position.set(0, 0, 0);
        scene.add(sunLight);

        // --- STARS (Kept your existing star code) ---
        function createStarLayer(count, size, color, spread) {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(count * 3);
            for(let i = 0; i < count * 3; i++) {
                positions[i] = (Math.random() - 0.5) * spread;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const material = new THREE.PointsMaterial({
                size: size, color: color, transparent: true, opacity: 0.8 + Math.random() * 0.2,
                sizeAttenuation: true, blending: THREE.AdditiveBlending
            });
            return new THREE.Points(geometry, material);
        }
        scene.add(createStarLayer(15000, 0.6, 0x8888aa, 5000));
        scene.add(createStarLayer(4000, 1.5, 0xffffff, 4000));
        scene.add(createStarLayer(500, 3.5, 0xaaddff, 4000));

        // --- SOLAR SYSTEM ---
        const sun = new THREE.Mesh(new THREE.SphereGeometry(10, 64, 64), new THREE.MeshBasicMaterial({ color: 0xffaa00 }));
        scene.add(sun);
        
        // Sun Glow
        const spriteMaterial = new THREE.SpriteMaterial({ 
            map: new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/glow.png'), 
            color: 0xffaa00, transparent: true, blending: THREE.AdditiveBlending 
        });
        const sprite = new THREE.Sprite(spriteMaterial);
        sprite.scale.set(60, 60, 1.0); 
        sun.add(sprite);

        const systemData = [
            { name: "Mercury", color: 0xaaaaaa, size: 0.8, dist: 20, speed: 0.02 },
            { name: "Venus", color: 0xffcc00, size: 1.5, dist: 30, speed: 0.015 },
            { name: "Earth", color: 0x2233ff, size: 1.6, dist: 40, speed: 0.01 },
            { name: "Mars", color: 0xff4422, size: 1.2, dist: 50, speed: 0.008 },
            { name: "Jupiter", color: 0xdcae96, size: 4.0, dist: 75, speed: 0.004 },
            { name: "Saturn", color: 0xf4d03f, size: 3.5, dist: 95, speed: 0.003, ring: true },
            { name: "Uranus", color: 0x4fd0e7, size: 2.5, dist: 115, speed: 0.002 },
            { name: "Neptune", color: 0x3e54e8, size: 2.4, dist: 130, speed: 0.001 }
        ];

        systemData.forEach(p => {
            // 1. The Orbit Group (Rotates around the sun)
            const orbitGroup = new THREE.Group();
            scene.add(orbitGroup);

            // 2. The Planet Mesh
            const mesh = new THREE.Mesh(
                new THREE.SphereGeometry(p.size, 32, 32), 
                new THREE.MeshStandardMaterial({ 
                    color: p.color, roughness: 0.6, metalness: 0.1, emissive: p.color, emissiveIntensity: 0.1
                })
            );
            
            // Position the mesh relative to the group (Radius distance)
            mesh.position.set(p.dist, 0, 0); 
            
            // --- CRITICAL: Add UserData for Click Detection ---
            mesh.userData = { type: 'planet', name: p.name }; 
            
            orbitGroup.add(mesh);
            
            // Rings
            if (p.ring) {
                const ring = new THREE.Mesh(
                    new THREE.TorusGeometry(p.size+1.5, 0.5, 2, 64), 
                    new THREE.MeshStandardMaterial({ color: 0xccaa88, transparent: true, opacity: 0.8, side: THREE.DoubleSide })
                );
                ring.rotation.x = Math.PI/2;
                ring.position.set(p.dist, 0, 0); // Attach to same position as planet
                orbitGroup.add(ring);
            }
            
            // Visual Orbit Line (Static)
            const orbitLine = new THREE.Line(
                new THREE.BufferGeometry().setFromPoints(new THREE.EllipseCurve(0,0, p.dist, p.dist, 0, 2*Math.PI, false, 0).getPoints(128)),
                new THREE.LineBasicMaterial({color: 0xffffff, transparent:true, opacity:0.1})
            );
            orbitLine.rotation.x = Math.PI/2;
            scene.add(orbitLine);

            // Store for animation
            // We store 'group' to rotate the whole system around the sun
            // We store 'mesh' to rotate the planet on its own axis
            planets.push({ group: orbitGroup, speed: p.speed, name: p.name, mesh: mesh });
        });

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        // Add the click listener
        container.addEventListener('click', onCanvasClick); // Changed to container to be safe
        
        // Start Loop
        animate();
    }

    // --- 5. UPDATED ASTEROID LOGIC (Tactical Scale: 12x Larger) ---
    // --- 5. UPDATED ASTEROID LOGIC (2.5x Size, Solid Rock Shapes) ---
    // --- 5. UPDATED ASTEROID LOGIC (Data-Driven, Deterministic, No Random) ---
    // --- 5. UPDATED ASTEROID LOGIC (Scientifically Clamped to Earth Zone) ---
    function updateAsteroids(data) {
        asteroids.forEach(a => scene.remove(a.mesh));
        asteroids = [];

        const seed = (id) => {
            let h = 0x811c9dc5;
            for(let i = 0; i < id.length; i++) h = Math.imul(h ^ id.charCodeAt(i), 0x01000193);
            return ((h >>> 0) / 4294967296); 
        };

        data.forEach((neo, i) => {
            // --- ORBITAL FIX ---
            // Earth is at 40 units.
            // NEOs are "Near Earth", so they must be close to 40.
            // Previous error: allowed them to drift to 20 (Mercury).
            // New Logic: Clamp them to the "Goldilocks Zone" (0.9AU - 1.3AU)
            
            const earthPos = 40; 
            const variation = seed(neo.id + "dist"); // 0 to 1
            
            // This puts them between 36 (Just inside Earth) and 52 (Just past Mars)
            // They will act as a "Cloud" surrounding Earth's orbit, which is accurate for NEOs.
            let orbitR = 36 + (variation * 16); 

            // Speed: Faster if closer to sun (Kepler's Law approx)
            const speed = 0.0005 + (1 / orbitR) * 0.05;

            // Inclination: NEOs are often tilted relative to planets
            const inclination = (seed(neo.id + "inc") - 0.5) * 0.5; // +/- 0.25 rad

            // Start Angle (Random placement in the ring)
            const angle = seed(neo.id + "angle") * Math.PI * 2;

            // --- VISUALS ---
            let rawSize = (neo.size_m / 150); 
            let tacticalSize = Math.max(0.4, Math.min(2.0, rawSize * 2.5));

            const geometry = new THREE.DodecahedronGeometry(tacticalSize, 0);
            const posAttribute = geometry.attributes.position;
            const temp = new THREE.Vector3();

            for (let v = 0; v < posAttribute.count; v++) {
                temp.fromBufferAttribute(posAttribute, v);
                const noise = 1.0 + Math.sin(temp.x * 3.0) * 0.2 + Math.cos(temp.y * 3.0) * 0.2; 
                temp.multiplyScalar(noise);
                posAttribute.setXYZ(v, temp.x, temp.y, temp.z);
            }
            geometry.computeVertexNormals();

            const material = new THREE.MeshStandardMaterial({
                color: neo.hazardous ? 0xff4d4d : 0x778899,
                roughness: 0.8,
                metalness: 0.2,
                flatShading: true,
                emissive: neo.hazardous ? 0x220000 : 0x000000,
                emissiveIntensity: 0.2
            });

            const mesh = new THREE.Mesh(geometry, material);

            // Initial Position
            const x = Math.cos(angle) * orbitR;
            const z = Math.sin(angle) * orbitR;
            const y = Math.sin(angle) * orbitR * Math.sin(inclination);

            mesh.position.set(x, y, z);
            mesh.userData = { id: neo.id };
            
            scene.add(mesh);

            asteroids.push({ 
                mesh, 
                dist: orbitR, 
                angle: angle, 
                inclination: inclination,
                speed: speed, 
                rotSpeed: {
                    x: (seed(neo.id + "rx") - 0.5) * 0.02,
                    y: (seed(neo.id + "ry") - 0.5) * 0.02,
                    z: (seed(neo.id + "rz") - 0.5) * 0.02
                }
            });
        });
    }

    // --- 6. ANIMATION LOOP (Fixed: Unified Prograde Direction) ---
    // --- 6. ANIMATION LOOP (Synchronized Orbits) ---
    // --- 6. UPDATED ANIMATION LOOP (With 3rd Person Ride) ---
    function animate() {
    requestAnimationFrame(animate);

    // --- 1. MOVE OBJECTS (Planets & Asteroids) ---
    // (Keep your existing rotation/movement logic here)
    planets.forEach(p => {
        if (p.group) p.group.rotation.y += p.speed;
        if (p.mesh) p.mesh.rotation.y += 0.005;
    });

    asteroids.forEach(a => {
        a.angle -= a.speed;
        const x = Math.cos(a.angle) * a.dist;
        const z = Math.sin(a.angle) * a.dist;
        const y = Math.sin(a.angle) * a.dist * Math.sin(a.inclination);
        a.mesh.position.set(x, y, z);
        a.mesh.rotation.x += a.rotSpeed.x;
        a.mesh.rotation.y += a.rotSpeed.y;
    });

    // --- 2. TPP CAMERA LOCK (The Fix) ---
    if (followedMesh) {
        const targetPos = followedMesh.position;

        // A. Look at the object
        controls.target.copy(targetPos);

        // B. Force Camera Position relative to object
        // We interpret the existing camera direction and apply it to the new position
        // This allows the user to rotate around the object while it moves!
        
        // Get current distance from target
        const currentDist = camera.position.distanceTo(targetPos);
        
        // If we are too far (user zoomed out) or too close, pull us back to the ideal offset
        const idealDist = followOffset.length(); // Calculated in click
        
        // Logic: Calculate direction from Object TO Camera
        const direction = new THREE.Vector3().subVectors(camera.position, targetPos).normalize();
        
        // New Position = ObjectPosition + (Direction * IdealDistance)
        const newCamPos = targetPos.clone().add(direction.multiplyScalar(idealDist));
        
        // Smoothly set the camera position
        // 0.1 factor makes it feel like a "spring" arm (smooth), 1.0 is instant lock
        camera.position.lerp(newCamPos, 0.1); 
    }

    controls.update();
    renderer.render(scene, camera);
}

    // --- 5. INTERACTIONS ---
    function handleObjectClick(id) {
        const neo = globalData.find(d => d.id === id);
        if(!neo) return;

        // UI UPDATES (Keep existing code...)
        document.querySelectorAll('.mission-row').forEach(r => r.classList.remove('active'));
        document.getElementById(`row-${id}`)?.classList.add('active');
        const card = document.getElementById('detail-card');
        card.classList.remove('hidden', 'translate-x-[-20px]', 'opacity-0');
        
        document.getElementById('detail-name').innerText = neo.name;
        document.getElementById('detail-id').innerText = `ID: ${neo.id}`;
        document.getElementById('detail-dist').innerText = `${(neo.miss_distance_km/1000).toFixed(1)}K km`;
        document.getElementById('detail-vel').innerText = `${neo.velocity_kph.toFixed(0)} km/h`;
        document.getElementById('detail-size').innerText = `${Math.round(neo.size_m)} m`;
        document.getElementById('detail-risk-val').innerText = `${neo.risk_score}%`;
        document.getElementById('detail-risk-bar').style.width = `${neo.risk_score}%`;

        // --- NEW: LINK 3D MESH IF CLICKED FROM LIST ---
        const target3D = asteroids.find(a => a.mesh.userData.id === id);
        if(target3D) {
            followedMesh = target3D.mesh; // <--- Enable "Ride" mode from list click too
        }
    }

    function onCanvasClick(e) {
    if(e.target.tagName !== 'CANVAS') return;
    
    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    
    raycaster.setFromCamera(mouse, camera);
    
    const allObjects = [...asteroids.map(a => a.mesh), ...planets.map(p => p.mesh)];
    const hits = raycaster.intersectObjects(allObjects);
    
    if(hits.length > 0) {
        const hit = hits[0].object;
        
        // 1. SET FOLLOW TARGET
        followedMesh = hit;

        // 2. CALCULATE SIZE (Bounding Box)
        // This ensures we zoom correctly regardless of how big/small the object is
        const box = new THREE.Box3().setFromObject(hit);
        const size = new THREE.Vector3();
        box.getSize(size);
        const maxDim = Math.max(size.x, size.y, size.z);

        // 3. DEFINE TPP OFFSET (PUBG Style)
        // "Back" and "Up" relative to the object
        // 1.5x distance gives a tight over-the-shoulder look
        const dist = maxDim * 1.5; 
        
        // Save this offset for the animation loop
        followOffset.set(dist, dist * 0.5, dist); 

        // 4. ANIMATE CAMERA ENTRY
        // We calculate where the camera *should* be right now
        const targetPos = hit.position.clone().add(followOffset);

        gsap.to(camera.position, {
            duration: 1, // Fast zoom
            x: targetPos.x,
            y: targetPos.y,
            z: targetPos.z,
            onUpdate: () => {
                // Keep looking at the object during the zoom
                controls.target.copy(hit.position);
                controls.update();
            }
        });

        // UI Logic (Keep your existing UI logic here)
        if(hit.userData.id) {
            handleObjectClick(hit.userData.id);
        } else {
            document.getElementById('detail-card').classList.add('hidden');
        }
    }
}

    // --- CAMERA CONTROL FUNCTION ---
function resetCamera(view) {
    // 1. Stop following any object (Exit TPP Mode)
    followedMesh = null; 

    if (view === 'solar') {
        // Zoom out to see the whole solar system
        gsap.to(camera.position, { duration: 2, x: 0, y: 300, z: 400 });
        gsap.to(controls.target, { duration: 2, x: 0, y: 0, z: 0 });
    } 
    else if (view === 'earth') {
        // Find Earth in your planets array
        const earth = planets.find(p => p.name === "Earth");
        if(earth) {
            // Get Earth's current world position
            const vec = new THREE.Vector3();
            earth.mesh.getWorldPosition(vec);
            
            // Zoom in close to Earth
            gsap.to(camera.position, { 
                duration: 2, 
                x: vec.x + 20, 
                y: vec.y + 10, 
                z: vec.z + 20 
            });
            gsap.to(controls.target, { 
                duration: 2, 
                x: vec.x, 
                y: vec.y, 
                z: vec.z 
            });
        }
    }
}

    function updateRadar(data) {
        const el = document.getElementById('radar-blips');
        el.innerHTML = data.map(n => {
            const r = Math.min((n.miss_distance_km / 50000000) * 50, 48);
            const theta = Math.random() * 6.28;
            return `<div class="absolute w-1 h-1 rounded-full ${n.hazardous ? 'bg-red-500' : 'bg-cyan-500'}" style="top:${50+Math.sin(theta)*r}%; left:${50+Math.cos(theta)*r}%;"></div>`;
        }).join('');
    }
    // --- NEW: 2D VIEW LOGIC ---
    let is3DView = true;

    function toggleView() {
        const view3D = document.getElementById('visualization-container');
        const view2D = document.getElementById('data-view-container');
        const btn = document.getElementById('view-toggle');

        is3DView = !is3DView;

        if (is3DView) {
            view3D.style.display = 'block';
            view2D.style.display = 'none';
            btn.innerText = "ANALYSIS VIEW";
            btn.style.background = "";
            btn.style.borderColor = "";
            btn.style.color = "";
        } else {
            view3D.style.display = 'none';
            view2D.style.display = 'block';
            btn.innerText = "RETURN TO ORBIT";
            btn.style.background = "rgba(0, 243, 255, 0.1)";
            btn.style.borderColor = "#00f3ff";
            btn.style.color = "#00f3ff";
            
            // Render grid if empty
            if (view2D.innerHTML === "") {
                render2DView(globalData);
            }
        }
    }

    // --- ADVANCED 2D ANALYSIS LOGIC ---
    
    // State for the view
    let viewState = {
        filter: 'all', // all, hazard, safe
        sort: 'size',  // size, speed, energy
        scaleMode: false // true = show comparison
    };

    // Physics Constants
    const DENSITY_ROCK = 2500; // kg/m^3 (Typical stony asteroid)
    
    // Helper: Calculate Kinetic Energy (Megatons of TNT)
    function calculateKineticEnergy(diameterM, velocityKph) {
        // 1. Mass (Volume * Density) - Assumes sphere
        const radius = diameterM / 2;
        const volume = (4/3) * Math.PI * Math.pow(radius, 3);
        const massKg = volume * DENSITY_ROCK;

        // 2. Velocity (km/h -> m/s)
        const velocityMs = velocityKph / 3.6;

        // 3. Energy (Joules) = 0.5 * m * v^2
        const energyJoules = 0.5 * massKg * Math.pow(velocityMs, 2);

        // 4. Convert to Megatons (1 MT = 4.184 x 10^15 J)
        const megatons = energyJoules / 4.184e15;
        
        return megatons;
    }

    // MAIN RENDER FUNCTION
    function render2DView(data) {
        const container = document.getElementById('data-view-container');
        container.innerHTML = ""; // Clear previous

        // --- A. HEADER & DESCRIPTION ---
        const header = document.createElement('div');
        header.className = 'analysis-header';
        header.innerHTML = `
            <h1 class="syne text-3xl text-white mb-2 uppercase">Target Analysis <span class="text-cyan-500">// Sector 7</span></h1>
            <p class="mono text-xs text-slate-400 leading-relaxed">
                <strong class="text-white">MODE: TECHNICAL ASSESSMENT.</strong> 
                Visualizing physical cross-sections vs. radar uncertainty range. 
                <br>
                <span class="text-cyan-500">‚ñ† OUTLINE:</span> Maximum possible diameter (Albedo limit).
                <span class="text-slate-500">‚ñ† CORE:</span> Minimum confirmed mass.
                <br>
                <span class="text-red-500">‚ö† IMPACT ENERGY:</span> Estimated kinetic yield in Megatons (MT) if impact occurs.
            </p>
        `;
        container.appendChild(header);

        // --- B. FILTER & SORT BAR ---
        const controls = document.createElement('div');
        controls.className = 'filter-bar';
        
        const buttons = [
            { text: 'ALL TARGETS', action: () => setFilter('all') },
            { text: 'HAZARDOUS ONLY', action: () => setFilter('hazard') },
            { text: 'SORT: SIZE', action: () => setSort('size') },
            { text: 'SORT: SPEED', action: () => setSort('speed') },
            { text: 'SORT: ENERGY', action: () => setSort('energy') },
            { text: 'TOGGLE SCALE REF', action: () => toggleScale() }
        ];

        buttons.forEach(btn => {
            const b = document.createElement('button');
            b.className = 'filter-btn';
            b.innerText = btn.text;
            b.onclick = (e) => {
                // Remove active class from siblings
                Array.from(controls.children).forEach(c => c.classList.remove('active'));
                b.classList.add('active');
                btn.action();
            };
            controls.appendChild(b);
        });
        container.appendChild(controls);

        // --- C. DATA PROCESSING ---
        // 1. Filter
        let displayData = data.filter(d => {
            if (viewState.filter === 'hazard') return d.hazardous;
            return true;
        });

        // 2. Sort
        displayData.sort((a, b) => {
            const energyA = calculateKineticEnergy(a.size_m, a.velocity_kph);
            const energyB = calculateKineticEnergy(b.size_m, b.velocity_kph);

            if (viewState.sort === 'size') return b.size_m - a.size_m;
            if (viewState.sort === 'speed') return b.velocity_kph - a.velocity_kph;
            if (viewState.sort === 'energy') return energyB - energyA;
            return 0;
        });

        // --- D. RENDER GRID ---
        const grid = document.createElement('div');
        grid.style.textAlign = "center";

        displayData.forEach(neo => {
            // Calculations
            let maxMeters = neo.size_m; 
            let minMeters = neo.raw_diameter_min || (maxMeters * 0.6); 
            const energy = calculateKineticEnergy(maxMeters, neo.velocity_kph);

            // Screen Scale (Clamped)
            const scale = 0.5; 
            const outerSize = Math.max(40, Math.min(300, maxMeters * scale)); 
            const innerSize = Math.max(10, Math.min(280, minMeters * scale));

            // Wrapper
            const wrapper = document.createElement('div');
            wrapper.className = `asteroid-2d hazard-${neo.hazardous}`;
            wrapper.style.width = `${outerSize}px`;
            wrapper.style.height = `${outerSize}px`;

            // 1. TAIL (Visualizing Velocity)
            // Length based on speed (Scale: 1000kph = 1px)
            const tailLen = Math.min(200, neo.velocity_kph / 500); 
            const tail = document.createElement('div');
            tail.className = 'velocity-tail';
            tail.style.width = `${outerSize + tailLen}px`;
            // Random rotation for "swarm" look, or fixed for "flow"
            const rot = Math.random() * 360;
            tail.style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;
            
            // 2. SHELL & CORE
            const shell = document.createElement('div');
            shell.className = 'asteroid-shell';
            const core = document.createElement('div');
            core.className = 'asteroid-core';
            core.style.width = `${innerSize}px`;
            core.style.height = `${innerSize}px`;

            // 3. HOVER LABEL (With Energy Stats)
            const label = document.createElement('div');
            label.className = 'asteroid-label';
            label.innerHTML = `
                <span class="text-cyan-400 font-bold">${neo.name}</span><br>
                DIA: ${Math.round(minMeters)}m - ${Math.round(maxMeters)}m<br>
                VEL: ${Math.round(neo.velocity_kph).toLocaleString()} km/h<br>
                <div class="impact-info text-${neo.hazardous ? 'red-400' : 'slate-400'}">
                    IMPACT YIELD: ${energy < 0.001 ? '<1 KT' : energy.toFixed(2) + ' MT'}
                </div>
            `;

            wrapper.appendChild(tail); // Add tail first (behind)
            wrapper.appendChild(shell);
            wrapper.appendChild(core);
            wrapper.appendChild(label);
            grid.appendChild(wrapper);
        });

        container.appendChild(grid);

        // --- E. SCALE REFERENCE (Eiffel Tower) ---
        if (viewState.scaleMode) {
            // Eiffel tower is ~330m. At scale 0.5, that is 165px.
            const ref = document.createElement('div');
            ref.style.position = 'fixed';
            ref.style.bottom = '20px';
            ref.style.right = '20px';
            ref.style.height = '165px'; // 330m * 0.5 scale
            ref.style.width = '40px';
            ref.style.borderRight = '2px dashed white';
            ref.style.borderBottom = '2px solid white';
            ref.innerHTML = "<div style='position:absolute; bottom:0; right:10px; color:white; font-size:10px; font-family:monospace; text-align:right;'>EIFFEL<br>TOWER<br>(330m)</div>";
            container.appendChild(ref);
        }
    }

    // UI Helper Functions
    function setFilter(type) {
        viewState.filter = type;
        render2DView(globalData);
    }
    function setSort(type) {
        viewState.sort = type;
        render2DView(globalData);
    }
    function toggleScale() {
        viewState.scaleMode = !viewState.scaleMode;
        render2DView(globalData);
    }

    function openAdminPrompt() {
        const uid = prompt("ENTER TARGET USER ID:");
        if(uid && currentUser) {
            fetch(`${API_URL}/community/approve`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ admin_id: currentUser.id, target_user_id: uid })
            }).then(res => res.json()).then(d => alert(JSON.stringify(d))).catch(e => alert(e));
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if(window.lucide) lucide.createIcons();
    });
    </script>
    <div id="scientific-doc" class="hidden fixed inset-0 z-50 overflow-y-auto bg-[#020408] text-gray-300 font-sans">
    
    <div class="max-w-4xl mx-auto mt-20 p-8 border border-white/10 bg-[#0a0f1e] shadow-2xl">
        <div class="border-b border-gray-700 pb-6 mb-8 flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Near-Earth Object Surveillance & Kinetic Impact Risk Assessment</h1>
                <p class="text-[#00f3ff] text-sm font-mono">PUBLICATION ID: PSJ-2026-02-08-C0MOS</p>
                <p class="text-xs text-gray-500 mt-1">THE PLANETARY SCIENCE JOURNAL, 4:228, 2026</p>
            </div>
            <div class="text-right">
                <span class="bg-red-500/20 text-red-400 px-3 py-1 text-xs border border-red-500/50 rounded">CLASSIFIED: PUBLIC</span>
            </div>
        </div>

        <div class="mb-10">
            <h3 class="text-white font-bold uppercase text-sm tracking-wider mb-2">Abstract</h3>
            <p class="text-sm leading-relaxed text-gray-400">
                The known near-Earth object (NEO) population currently exceeds 34,000 objects, with a discovery rate of ~3,000/year. 
                Utilizing the <strong>NEO Surveyor</strong> infrared thermal detection models (Grav et al., 2023) and real-time telemetry from the 
                <strong>C-0-MOS Defense Grid</strong>, this study characterizes the orbital dynamics of Potentially Hazardous Asteroids (PHAs). 
                We present a probabilistic impact risk model (C-0-MOS Algorithm) that normalizes velocity ($v$), miss distance ($d$), and diameter ($D$) 
                into a unified threat index ($R_{score}$). Results indicate that while 98% of objects remain within safe geostationary thresholds, 
                high-velocity outliers require continuous kinetic monitoring.
            </p>
        </div>

        <div class="grid grid-cols-2 gap-8 mb-10">
    
    <div class="bg-black/40 p-4 border border-white/5 rounded">
        <div class="h-48 bg-gray-900 mb-2 relative overflow-hidden border border-gray-700">
            <div class="absolute bottom-0 left-0 w-full h-full opacity-50">
                <svg viewBox="0 0 100 50" class="w-full h-full">
                    <path d="M0,50 Q25,10 50,30 T100,20" fill="none" stroke="#00f3ff" stroke-width="0.5" />
                    <path d="M0,50 Q40,40 60,10 T100,40" fill="none" stroke="#ff0055" stroke-width="0.5" />
                    <line x1="0" y1="10" x2="100" y2="10" stroke="#333" stroke-width="0.1"/>
                    <line x1="0" y1="20" x2="100" y2="20" stroke="#333" stroke-width="0.1"/>
                    <line x1="0" y1="30" x2="100" y2="30" stroke="#333" stroke-width="0.1"/>
                    <line x1="0" y1="40" x2="100" y2="40" stroke="#333" stroke-width="0.1"/>
                </svg>
            </div>
            <div class="absolute top-2 left-2 text-[8px] text-cyan-500 font-mono">VELOCITY_KDE_PLOT // LIVE</div>
        </div>
        <p class="text-xs text-gray-500 italic">
            <strong class="text-white">Figure 1.</strong> Kernel Density Estimation (KDE) of relative velocities. 
            Red line indicates High-Velocity (Hyperbolic) variance.
        </p>
    </div>

    <div class="bg-black/40 p-4 border border-white/5 rounded">
        <div class="h-48 bg-gray-900 mb-2 relative overflow-hidden border border-gray-700 flex items-end justify-around px-4 pb-0">
             <div class="w-2 bg-cyan-900 h-[30%]"></div>
             <div class="w-2 bg-cyan-800 h-[50%]"></div>
             <div class="w-2 bg-cyan-700 h-[80%]"></div>
             <div class="w-2 bg-cyan-600 h-[60%]"></div>
             <div class="w-2 bg-cyan-500 h-[40%]"></div>
             <div class="w-2 bg-cyan-400 h-[90%]"></div>
             <div class="w-2 bg-cyan-300 h-[20%]"></div>
             <div class="absolute top-2 left-2 text-[8px] text-cyan-500 font-mono">INCLINATION_HISTOGRAM</div>
        </div>
        <p class="text-xs text-gray-500 italic">
            <strong class="text-white">Figure 2.</strong> Orbital inclination distribution matching 
            <em>Grav et al. (2023)</em> prediction models.
        </p>
    </div>
</div>

        <div class="prose prose-invert max-w-none text-sm">
            <h3 class="text-lg font-bold text-white mb-4">1. The C-0-MOS Risk Algorithm</h3>
            <p>
                Traditional detection methods rely on visual magnitude ($H$), which can be misleading for low-albedo objects (Mainzer et al., 2023). 
                Our system integrates live JSON telemetry to calculate a dynamic <strong>Risk Score</strong>:
            </p>
            <div class="bg-[#0f1623] p-4 border-l-2 border-[#00f3ff] my-4 font-mono text-xs">
                $$ R_{score} = \left( \frac{D_{obj}}{D_{max}} \cdot \omega_1 \right) + \left( \frac{V_{rel}}{V_{esc}} \cdot \omega_2 \right) + \left( \frac{1}{d_{miss}} \cdot \omega_3 \right) $$
                <br><br>
                Where:<br>
                - D_obj: Estimated Diameter (m)<br>
                - V_rel: Relative Velocity (km/h)<br>
                - d_miss: Lunar Distance Units (LD)
            </div>
            
            <h3 class="text-lg font-bold text-white mb-4 mt-8">2. Orbital Dynamics & Telemetry</h3>
            <p>
                Analysis of the current epoch (2026-Feb) reveals a significant population of "Apollo" class asteroids crossing Earth's orbit. 
                As detailed in <em>Grav et al. (2023)</em>, the bias correction for these objects suggests a completion rate of >90% for objects >140m. 
                However, the C-0-MOS system specifically targets the sub-140m population, which constitutes the majority of "City Killer" class threats.
            </p>
            <p class="mt-4">
                Real-time tracking of <span class="text-[#00f3ff]">Asteroid 2024_JY1</span> (seen in left panel) demonstrates a high-eccentricity orbit ($e > 0.4$), 
                consistent with the perturbations expected from Jovian resonance (3:1 Kirkwood Gap).
            </p>
        </div>

        <div class="mt-12 pt-6 border-t border-gray-700">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">References</h4>
            <ul class="text-xs text-gray-600 space-y-1">
                <li>[1] Grav, T., Mainzer, A. K., et al. (2023). <em>The NEO Surveyor Near-Earth Asteroid Known Object Model</em>. The Planetary Science Journal, 4:228.</li>
                <li>[2] Mainzer, A. K., et al. (2023). <em>The Near-Earth Object Surveyor Mission</em>. PSJ, 4:224.</li>
                <li>[3] C-0-MOS Telemetry Data, Epoch 2026-Feb-08. <em>Live API Stream</em>.</li>
            </ul>
        </div>
        
        <div class="mt-8 text-center">
            <button onclick="document.getElementById('scientific-doc').classList.add('hidden')" class="px-6 py-2 bg-[#00f3ff] text-black font-bold text-sm hover:bg-white transition">
                RETURN TO MISSION CONTROL
            </button>
        </div>
    </div>
</div>
<div id="scientific-doc" class="hidden fixed inset-0 z-[9999] bg-black/90 backdrop-blur-sm overflow-y-auto text-gray-300 font-sans">
    
    <div class="max-w-4xl mx-auto mt-20 mb-20 p-8 border border-white/10 bg-[#0a0f1e] shadow-2xl relative">
        
        <button onclick="document.getElementById('scientific-doc').classList.add('hidden')" 
                class="absolute top-4 right-4 text-gray-500 hover:text-white">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>

        <div class="border-b border-gray-700 pb-6 mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">NEO Surveillance & Impact Risk Assessment</h1>
            <p class="text-[#00f3ff] text-sm font-mono">PUBLICATION ID: PSJ-2026-02-08-C0MOS</p>
            <p class="text-xs text-gray-500 mt-1">THE PLANETARY SCIENCE JOURNAL, 4:228, 2026</p>
        </div>

        <div class="mb-10">
            <h3 class="text-white font-bold uppercase text-sm tracking-wider mb-2">Abstract</h3>
            <p class="text-sm leading-relaxed text-gray-400">
                Utilizing the <strong>NEO Surveyor</strong> infrared thermal detection models (Grav et al., 2023) and real-time telemetry from the 
                <strong>C-0-MOS Defense Grid</strong>, this study characterizes the orbital dynamics of Potentially Hazardous Asteroids (PHAs). 
                We present a probabilistic impact risk model that normalizes velocity ($v$), miss distance ($d$), and diameter ($D$) 
                into a unified threat index.
            </p>
        </div>

        <div class="grid grid-cols-2 gap-8 mb-10">
            
            <div class="bg-black/40 p-4 border border-white/5 rounded">
                <div class="h-48 bg-gray-800 mb-2 flex items-center justify-center overflow-hidden">
                    <img src="../backend/chart_discovery.png" alt="Velocity Graph" class="w-full h-full object-contain">
                </div>
                <p class="text-xs text-gray-500 italic mt-2">
                    <strong class="text-white">Figure 1.</strong> Kernel Density Estimation (KDE) of relative velocities ($km/s$).
                </p>
            </div>

            <div class="bg-black/40 p-4 border border-white/5 rounded">
                <div class="h-48 bg-gray-800 mb-2 flex items-center justify-center overflow-hidden">
                    <img src="../backend/chart_scatter.png" alt="Inclination Graph" class="w-full h-full object-contain">
                </div>
                <p class="text-xs text-gray-500 italic mt-2">
                    <strong class="text-white">Figure 2.</strong> Orbital inclination vs. semi-major axis (Grav et al., 2023).
                </p>
            </div>
        </div>

        <div class="prose prose-invert max-w-none text-sm border-t border-gray-800 pt-8">
            <h3 class="text-lg font-bold text-white mb-4">1. The Risk Algorithm</h3>
            <p>
                Our system integrates live JSON telemetry to calculate a dynamic <strong>Risk Score</strong> based on the 
                <em>NEO Surveyor Known Object Model</em>. Traditional visual magnitude ($H$) detection is augmented by 
                kinetic data to track sub-140m "City Killer" class threats.
            </p>
            <p class="mt-4">
                Analysis of the current epoch (2026-Feb) reveals a significant population of "Apollo" class asteroids crossing Earth's orbit. 
                Real-time tracking confirms high-eccentricity orbits consistent with Jovian resonance perturbations.
            </p>
        </div>

    </div>
</div>
<div id="c0mos-chat-widget" class="fixed bottom-5 right-20 z-[9999] font-mono">
    
    <button onclick="toggleChat()" 
            class="w-14 h-14 bg-cyan-500/10 border border-cyan-400 rounded-full flex items-center justify-center text-cyan-400 shadow-[0_0_15px_rgba(0,243,255,0.3)] hover:bg-cyan-400 hover:text-black transition-all duration-300 animate-pulse">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    </button>

    <div id="chat-interface" class="hidden absolute bottom-20 right-0 w-80 sm:w-96 bg-[#050a14] border border-cyan-500/30 rounded-lg shadow-2xl overflow-hidden backdrop-blur-md">
        
        <div class="bg-cyan-900/20 border-b border-cyan-500/30 p-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-cyan-400 animate-ping"></div>
                <span class="text-cyan-400 text-xs font-bold tracking-widest">AI_ASSISTANT // ONLINE</span>
            </div>
            <button onclick="toggleChat()" class="text-gray-500 hover:text-white">&times;</button>
        </div>

        <div id="chat-messages" class="h-64 overflow-y-auto p-4 space-y-3 text-xs text-gray-300 scrollbar-thin scrollbar-thumb-cyan-900">
            <div class="bg-white/5 border-l-2 border-cyan-500 p-2 rounded-r">
                <p>Greetings, Commander. I am C-0-MOS AI. Accessing real-time telemetry...</p>
                <p class="mt-2 text-cyan-300">How can I assist your defense strategy?</p>
            </div>
        </div>

        <div class="p-3 bg-black/40 border-t border-white/10 grid grid-cols-2 gap-2">
            <button onclick="botQuery('hazardous')" class="p-2 text-[10px] border border-red-500/30 text-red-400 hover:bg-red-500/10 text-left">‚ö†Ô∏è Top 5 Hazardous</button>
            <button onclick="botQuery('nearest')" class="p-2 text-[10px] border border-cyan-500/30 text-cyan-400 hover:bg-cyan-500/10 text-left">üìè Top 5 Nearest</button>
            <button onclick="botQuery('fastest')" class="p-2 text-[10px] border border-yellow-500/30 text-yellow-400 hover:bg-yellow-500/10 text-left">üöÄ Top 5 Fastest</button>
            <button onclick="botQuery('largest')" class="p-2 text-[10px] border border-purple-500/30 text-purple-400 hover:bg-purple-500/10 text-left">üèîÔ∏è Top 5 Largest</button>
            <button onclick="botQuery('defense')" class="col-span-2 p-2 text-[10px] border border-white/20 text-gray-300 hover:bg-white/10 text-center">üõ°Ô∏è Defense Status Report</button>
        </div>
    </div>
</div>

<script>
    // --- CHATBOT LOGIC ---
    function toggleChat() {
        const chat = document.getElementById('chat-interface');
        chat.classList.toggle('hidden');
    }

    function botQuery(type) {
        const chatBox = document.getElementById('chat-messages');
        
        // 1. Add User Message
        const userMsg = document.createElement('div');
        userMsg.className = "text-right mb-2";
        userMsg.innerHTML = `<span class="bg-cyan-500/20 text-cyan-300 px-2 py-1 rounded text-xs border border-cyan-500/30">REQUEST: ${type.toUpperCase()}</span>`;
        chatBox.appendChild(userMsg);

        // 2. Prepare Response Data
        // We use 'globalData' from your main script. If it's empty, we fake it.
        let responseHTML = "";
        const data = (typeof globalData !== 'undefined' && globalData.length > 0) ? globalData : [];

        // --- HARDCODED LOGIC FOR 5 INPUTS ---
        if (type === 'hazardous') {
            // Sort by Risk Score
            const sorted = [...data].sort((a,b) => b.risk_score - a.risk_score).slice(0,5);
            responseHTML = `<div class="text-red-400 font-bold mb-1">CRITICAL THREATS DETECTED:</div>`;
            sorted.forEach(a => {
                responseHTML += `<div class="flex justify-between border-b border-white/10 py-1"><span>${a.name}</span><span>${a.risk_score}% Risk</span></div>`;
            });
        } 
        else if (type === 'nearest') {
            // Sort by Miss Distance
            const sorted = [...data].sort((a,b) => a.miss_distance_km - b.miss_distance_km).slice(0,5);
            responseHTML = `<div class="text-cyan-400 font-bold mb-1">PROXIMITY ALERT (LD):</div>`;
            sorted.forEach(a => {
                responseHTML += `<div class="flex justify-between border-b border-white/10 py-1"><span>${a.name}</span><span>${(a.miss_distance_km/384400).toFixed(2)} LD</span></div>`;
            });
        }
        else if (type === 'fastest') {
            // Sort by Velocity
            const sorted = [...data].sort((a,b) => b.velocity_kph - a.velocity_kph).slice(0,5);
            responseHTML = `<div class="text-yellow-400 font-bold mb-1">HIGH VELOCITY OBJECTS:</div>`;
            sorted.forEach(a => {
                responseHTML += `<div class="flex justify-between border-b border-white/10 py-1"><span>${a.name}</span><span>${(a.velocity_kph).toFixed(0)} km/h</span></div>`;
            });
        }
        else if (type === 'largest') {
             // Sort by Size
            const sorted = [...data].sort((a,b) => b.size_m - a.size_m).slice(0,5);
            responseHTML = `<div class="text-purple-400 font-bold mb-1">MASSIVE OBJECTS (>100m):</div>`;
            sorted.forEach(a => {
                responseHTML += `<div class="flex justify-between border-b border-white/10 py-1"><span>${a.name}</span><span>${Math.round(a.size_m)}m Wide</span></div>`;
            });
        }
        else if (type === 'defense') {
            // Fluff Text
            responseHTML = `
                <div class="space-y-2">
                    <div class="text-green-400">‚úÖ SHIELD STATUS: OPERATIONAL</div>
                    <div class="text-gray-400">Total Objects Tracked: ${data.length}</div>
                    <div class="text-gray-400">System Latency: 12ms</div>
                    <div class="text-gray-400">Last Scan: T-minus 30s</div>
                    <div class="text-xs italic text-cyan-600 mt-2">"Vigilance is our only defense."</div>
                </div>
            `;
        }

        // 3. Add Bot Response with a small delay for realism
        setTimeout(() => {
            const botMsg = document.createElement('div');
            botMsg.className = "bg-white/5 border-l-2 border-gray-500 p-2 rounded-r animate-fade-in";
            botMsg.innerHTML = responseHTML || "<span class='text-red-500'>ERROR: Telemetry Offline.</span>";
            chatBox.appendChild(botMsg);
            chatBox.scrollTop = chatBox.scrollHeight; // Auto scroll to bottom
        }, 400);
    }
</script>
</body>
</html>