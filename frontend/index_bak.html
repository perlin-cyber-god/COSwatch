<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Watch | Tactical Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-deep: #020408;
            --glass-panel: rgba(10, 15, 30, 0.75);
            --neon-cyan: #00f3ff;
            --hazard-red: #ff3b3b;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: white;
            margin: 0;
            overflow: hidden;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .syne { font-family: 'Syne', sans-serif; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .glass-panel {
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .mission-row:hover {
            background: rgba(0, 243, 255, 0.1);
            border-left: 2px solid var(--neon-cyan);
        }
        .mission-row.active {
            background: linear-gradient(90deg, rgba(0, 243, 255, 0.2) 0%, transparent 100%);
            border-left: 3px solid var(--neon-cyan);
        }
        .radar-sweep { animation: radar-spin 4s linear infinite; }
        @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #auth-overlay { transition: opacity 0.8s ease; }
        body.locked main { filter: blur(15px); pointer-events: none; }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden locked">

    <div id="auth-overlay" class="fixed inset-0 z-[999] bg-black/90 backdrop-blur-xl flex items-center justify-center">
        <div class="w-[400px] border border-white/10 bg-black/80 p-8 rounded-xl shadow-[0_0_50px_rgba(0,255,255,0.1)] relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent"></div>
            
            <div class="text-center mb-8">
                <h1 class="syne text-3xl uppercase tracking-widest text-white mb-2">Cosmic<span class="text-cyan-500">Watch</span></h1>
                <p class="mono text-[10px] text-slate-500 uppercase tracking-[0.2em]">Restricted Access // Sector 7</p>
            </div>

            <div class="space-y-4">
                <div class="space-y-2">
                    <input id="auth-email" type="email" placeholder="OPERATOR ID (EMAIL)" class="w-full bg-white/5 border border-white/10 p-3 text-xs mono text-white focus:border-cyan-500 outline-none transition-colors">
                    <input id="auth-pass" type="password" placeholder="ACCESS KEY" class="w-full bg-white/5 border border-white/10 p-3 text-xs mono text-white focus:border-cyan-500 outline-none transition-colors">
                </div>
                
                <div id="auth-error" class="hidden text-red-500 text-[10px] mono text-center uppercase tracking-widest animate-pulse">
                    INVALID CREDENTIALS
                </div>
                <div id="signup-msg" class="hidden text-cyan-400 text-[10px] mono text-center uppercase tracking-widest"></div>

                <div class="grid grid-cols-2 gap-3">
                    <button id="login-btn" onclick="handleLogin()" class="bg-cyan-600 hover:bg-cyan-500 text-white py-3 text-xs font-bold uppercase tracking-widest transition-all">
                        Login
                    </button>
                    <button id="signup-btn" onclick="handleSignUp()" class="border border-white/20 hover:bg-white/5 text-slate-300 py-3 text-xs font-bold uppercase tracking-widest transition-all">
                        Sign Up
                    </button>
                </div>

                <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div><span class="relative bg-black px-2 text-[9px] text-slate-500 mono uppercase block text-center">OR</span></div>
                
                <button onclick="handleGuest()" class="w-full py-2 text-[10px] text-slate-500 hover:text-cyan-400 mono uppercase tracking-widest transition-colors">
                    Initialize Guest Protocol
                </button>
            </div>
        </div>
    </div>

    <aside class="w-[380px] flex-shrink-0 bg-black/90 border-r border-white/10 flex flex-col z-20 relative">
        <div class="p-6 border-b border-white/10 bg-gradient-to-r from-slate-900 to-black">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_lime]"></div>
                <span class="text-[10px] mono uppercase tracking-[0.2em] text-slate-400">Live Telemetry</span>
            </div>
            <h1 class="syne text-3xl uppercase tracking-tighter leading-none">
                Cosmic<br/><span class="text-cyan-400">Watch</span>
            </h1>
            
            <div class="grid grid-cols-2 gap-2 mt-6">
                <div class="bg-white/5 p-3 rounded border border-white/5">
                    <span class="block text-[9px] mono text-slate-500 uppercase">Tracked Objects</span>
                    <span id="stat-objects" class="text-2xl font-bold mono">--</span>
                </div>
                <div class="bg-white/5 p-3 rounded border border-white/5">
                    <span class="block text-[9px] mono text-slate-500 uppercase">Highest Risk</span>
                    <span id="stat-risk" class="text-2xl font-bold mono text-yellow-500">--%</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 bg-black z-10 text-[10px] mono uppercase text-slate-500 border-b border-white/10">
                    <tr>
                        <th class="p-3 pl-6 font-normal">Designation</th>
                        <th class="p-3 pr-6 font-normal text-right">Hazard %</th>
                    </tr>
                </thead>
                <tbody id="neo-table-body"></tbody>
            </table>
        </div>

        <div class="p-3 border-t border-white/10 bg-black text-[10px] mono text-slate-600 flex justify-between items-center">
            <span id="status-indicator">AWAITING AUTH...</span>
            <span id="user-tier-badge" class="px-2 py-0.5 rounded bg-slate-800 text-slate-400">LOCKED</span>
        </div>
    </aside>

    <main class="flex-1 relative bg-black">
        <div id="visualization-container" class="absolute inset-0 z-0"></div>

        <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-10 pointer-events-none">
            <div class="pointer-events-auto flex gap-2">
                <button onclick="resetCamera('solar')" class="text-xs bg-white/5 text-slate-400 px-3 py-1 border border-white/10 hover:text-white hover:border-cyan-500">SYSTEM VIEW</button>
                <button onclick="resetCamera('earth')" class="text-xs bg-white/5 text-slate-400 px-3 py-1 border border-white/10 hover:text-white hover:border-cyan-500">EARTH VIEW</button>
            </div>
            <div class="flex flex-col items-end pointer-events-auto gap-4">
                 <button onclick="fetchNEOData()" class="text-cyan-500 hover:text-white transition-colors bg-white/5 p-2 rounded-full border border-white/10 hover:bg-cyan-500/20">
                    <i data-lucide="refresh-cw" size="18"></i>
                </button>
                <button id="admin-btn" onclick="openAdminPrompt()" class="hidden px-4 py-2 bg-red-500/10 border border-red-500/50 text-red-400 mono text-[10px] uppercase tracking-widest hover:bg-red-500 hover:text-white transition-all">
                    <i data-lucide="shield-alert" size="14" class="inline mr-1"></i> Admin Panel
                </button>
            </div>
        </div>

        <div id="detail-card" class="absolute top-24 left-8 w-[400px] glass-panel rounded-xl p-6 hidden z-20 pointer-events-auto transform transition-all duration-500 translate-x-[-20px] opacity-0">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span id="detail-id" class="text-[10px] mono text-cyan-500 uppercase tracking-widest">NEO-ID</span>
                        <div id="detail-hazard-badge" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Analyzing</div>
                    </div>
                    <h2 id="detail-name" class="syne text-4xl text-white leading-none tracking-tight">Object</h2>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="space-y-1">
                    <span class="text-[9px] mono text-slate-500 uppercase">Diameter</span>
                    <p id="detail-size" class="text-xl font-mono text-white">---</p>
                </div>
                <div class="space-y-1">
                    <span class="text-[9px] mono text-slate-500 uppercase">Velocity</span>
                    <p id="detail-vel" class="text-xl font-mono text-cyan-400">---</p>
                </div>
                <div class="space-y-1 col-span-2">
                    <span class="text-[9px] mono text-slate-500 uppercase">Miss Distance</span>
                    <p id="detail-dist" class="text-2xl font-mono text-white">---</p>
                </div>
            </div>

            <div class="mb-4 bg-white/5 p-3 rounded border border-white/5">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-[10px] mono text-slate-400 uppercase tracking-widest">Impact Probability</span>
                    <span id="detail-risk-val" class="text-xl font-bold text-white">0%</span>
                </div>
                <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                    <div id="detail-risk-bar" class="h-full bg-cyan-500 transition-all duration-1000 w-0"></div>
                </div>
            </div>
        </div>

        <div class="absolute top-24 right-8 z-20 pointer-events-auto flex flex-col items-center gap-2">
            <div class="relative w-72 h-72 rounded-full border border-white/20 bg-black/60 backdrop-blur-md flex items-center justify-center shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden">
                <div class="absolute inset-0 border rounded-full border-white/10 scale-75"></div>
                <div class="absolute inset-0 border rounded-full border-white/5 scale-50"></div>
                <div class="absolute w-full h-[1px] bg-white/10 top-1/2"></div>
                <div class="absolute h-full w-[1px] bg-white/10 left-1/2"></div>
                <div class="absolute w-1/2 h-1/2 top-0 left-0 origin-bottom-right radar-sweep border-r border-cyan-500/30 bg-gradient-to-l from-cyan-500/10 to-transparent"></div>
                <div id="radar-blips" class="absolute inset-0 w-full h-full"></div>
                <div class="absolute w-2 h-2 bg-cyan-400 rounded-full shadow-[0_0_10px_cyan] z-10"></div>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></span>
                <span class="text-[9px] mono text-cyan-400/80 uppercase tracking-widest">Active Scan // 50M KM</span>
            </div>
        </div>

    </main>

    <script>
    // --- 1. CONFIGURATION ---
    const SB_URL = "https://toamgacouwrwtibzbwyo.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvYW1nYWNvdXdyd3RpYnpid3lvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MzMwMzIsImV4cCI6MjA4NjAwOTAzMn0.RF1k9QJG6sL6N1CBwPfHH-Zv0Jou1Lh3202dHolkmL0";
    
    // SAFE VARIABLE NAME: sbClient
    const sbClient = supabase.createClient(SB_URL, SB_KEY);
    
    const API_URL = 'http://127.0.0.1:8000';
    const MOCK_DATA = [
        { name: "99942 Apophis", hazardous: true, velocity_kph: 30720, miss_distance_km: 31000, risk_score: 96, estimated_diameter: { meters: { estimated_diameter_max: 370 } } },
        { name: "2024 FG3", hazardous: false, velocity_kph: 15400, miss_distance_km: 12000000, risk_score: 5, estimated_diameter: { meters: { estimated_diameter_max: 22 } } }
    ];

    let scene, camera, renderer, controls;
    let asteroids = [];
    let planets = []; 
    let globalData = []; 
    let raycaster = new THREE.Raycaster();
    let mouse = new THREE.Vector2();
    let currentUser = null;

    // --- 2. AUTH FLOW ---
    async function handleLogin() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        const btn = document.getElementById('login-btn');
        const err = document.getElementById('auth-error');

        if (!email || !password) return;

        btn.innerText = "VERIFYING...";
        btn.disabled = true;
        err.classList.add('hidden');

        const { data, error } = await sbClient.auth.signInWithPassword({ email, password });

        if (error) {
            err.innerText = error.message.toUpperCase();
            err.classList.remove('hidden');
            btn.innerText = "LOGIN";
            btn.disabled = false;
        } else {
            await syncUserWithBackend(data.user.id);
        }
    }

    async function handleSignUp() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        const btn = document.getElementById('signup-btn');
        const msg = document.getElementById('signup-msg');
        const err = document.getElementById('auth-error');

        if(!email || !password) {
            err.innerText = "ENTER CREDENTIALS";
            err.classList.remove('hidden');
            return;
        }

        btn.innerText = "CREATING...";
        btn.disabled = true;

        const { data, error } = await sbClient.auth.signUp({ email, password });

        if (error) {
            err.innerText = error.message.toUpperCase();
            err.classList.remove('hidden');
            btn.innerText = "SIGN UP";
            btn.disabled = false;
        } else {
            msg.innerText = "ACCOUNT CREATED. LOGGING IN...";
            msg.classList.remove('hidden');
            if(data.session) {
                await syncUserWithBackend(data.user.id);
            } else {
                msg.innerText = "CONFIRM EMAIL TO CONTINUE";
            }
        }
    }

    async function syncUserWithBackend(userId) {
        try {
            console.log("Initializing User on Backend:", userId);
            const response = await fetch(`${API_URL}/user/init`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });
            
            if(!response.ok) throw new Error("Backend handshake failed");
            
            const result = await response.json();
            const tier = result.tier || 'researcher'; 
            
            unlockDashboard(tier.toUpperCase());
        } catch (e) {
            console.error("Sync Error:", e);
            unlockDashboard('RESEARCHER (OFFLINE)'); 
        }
    }

    function handleGuest() {
        unlockDashboard('GUEST');
    }

    function unlockDashboard(role) {
        const overlay = document.getElementById('auth-overlay');
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 800);
        document.body.classList.remove('locked');

        document.getElementById('status-indicator').innerHTML = `<span class="text-cyan-400 font-bold animate-pulse">‚óè SYSTEM ONLINE</span>`;
        document.getElementById('user-tier-badge').innerText = role;

        if (role === 'ADMIN') document.getElementById('admin-btn').classList.remove('hidden');

        init3D();
        fetchNEOData();
    }

    // --- 3. DATA LOGIC ---
    async function fetchNEOData() {
        try {
            console.log("Fetching NEO Feed...");
            const res = await fetch(`${API_URL}/neo/feed`);
            const rawData = await res.json();
            
            let processed = Array.isArray(rawData) ? rawData : MOCK_DATA;
            if (processed.length < 5) processed = processed.concat(MOCK_DATA);

            globalData = processed.map((obj, i) => {
                let vel = parseFloat(obj.velocity_kph) || 0;
                let dist = parseFloat(obj.miss_distance_km) || 0;
                let risk = obj.risk_score || (obj.hazardous ? 80 : 10);

                return {
                    id: `neo-${i}`,
                    name: obj.name || "Unknown",
                    velocity_kph: vel,
                    miss_distance_km: dist,
                    size_m: obj.estimated_diameter?.meters?.estimated_diameter_max || 50,
                    hazardous: obj.hazardous || false,
                    risk_score: Math.round(risk)
                };
            });

            globalData.sort((a, b) => b.risk_score - a.risk_score);
            updateUI(globalData);
            updateAsteroids(globalData);
            updateRadar(globalData);

        } catch (e) {
            console.warn("Fetch Failed:", e);
        }
    }

    function updateUI(data) {
        document.getElementById('stat-objects').innerText = data.length;
        document.getElementById('stat-risk').innerText = Math.max(...data.map(d=>d.risk_score||0)) + "%";
        document.getElementById('neo-table-body').innerHTML = data.map(neo => `
            <tr onclick="handleObjectClick('${neo.id}')" id="row-${neo.id}" class="mission-row cursor-pointer transition-colors border-b border-white/5">
                <td class="p-3 pl-6">
                    <div class="flex flex-col">
                        <span class="font-bold text-sm text-slate-200">${neo.name}</span>
                        <span class="text-[9px] mono text-slate-600 tracking-widest">ID: ${neo.id.split('-')[1]}</span>
                    </div>
                </td>
                <td class="p-3 pr-6 text-right">
                    <span class="mono text-xs font-bold ${neo.risk_score >= 70 ? 'text-red-500' : 'text-cyan-500'}">${neo.risk_score}%</span>
                </td>
            </tr>
        `).join('');
    }

    // --- 4. 3D SOLAR SYSTEM ---
    function init3D() {
        const container = document.getElementById('visualization-container');
        if (container.children.length > 0) return; 

        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.005);
        camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 10000);
        camera.position.set(0, 100, 150); 
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        container.appendChild(renderer.domElement);
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        scene.add(new THREE.AmbientLight(0x404040, 0.5));
        const sunLight = new THREE.PointLight(0xffaa00, 2, 800);
        scene.add(sunLight);

        // Sun
        const sun = new THREE.Mesh(new THREE.SphereGeometry(10, 32, 32), new THREE.MeshBasicMaterial({ color: 0xffaa00 }));
        scene.add(sun);

        // Planets
        const systemData = [
            { name: "Mercury", color: 0xaaaaaa, size: 0.8, dist: 20, speed: 0.02 },
            { name: "Venus", color: 0xffcc00, size: 1.5, dist: 30, speed: 0.015 },
            { name: "Earth", color: 0x2233ff, size: 1.6, dist: 40, speed: 0.01 },
            { name: "Mars", color: 0xff4422, size: 1.2, dist: 50, speed: 0.008 },
            { name: "Jupiter", color: 0xdcae96, size: 4.0, dist: 75, speed: 0.004 },
            { name: "Saturn", color: 0xf4d03f, size: 3.5, dist: 95, speed: 0.003, ring: true },
            { name: "Uranus", color: 0x4fd0e7, size: 2.5, dist: 115, speed: 0.002 },
            { name: "Neptune", color: 0x3e54e8, size: 2.4, dist: 130, speed: 0.001 }
        ];

        systemData.forEach(p => {
            const pGroup = new THREE.Group();
            const mesh = new THREE.Mesh(new THREE.SphereGeometry(p.size, 32, 32), new THREE.MeshStandardMaterial({ color: p.color }));
            mesh.position.x = p.dist;
            pGroup.add(mesh);
            
            if (p.ring) {
                const ring = new THREE.Mesh(new THREE.TorusGeometry(p.size+1.5, 0.5, 2, 32), new THREE.MeshBasicMaterial({ color: 0xccaa88, transparent: true, opacity: 0.6 }));
                ring.rotation.x = Math.PI/2;
                ring.position.x = p.dist;
                pGroup.add(ring);
            }
            
            const orbit = new THREE.Line(
                new THREE.BufferGeometry().setFromPoints(new THREE.EllipseCurve(0,0, p.dist, p.dist, 0, 2*Math.PI, false, 0).getPoints(128)),
                new THREE.LineBasicMaterial({color: 0xffffff, transparent:true, opacity:0.1})
            );
            orbit.rotation.x = Math.PI/2;
            scene.add(orbit);
            scene.add(pGroup);
            planets.push({ group: pGroup, speed: p.speed, name: p.name, mesh });
        });

        // Stars
        const stars = new THREE.BufferGeometry();
        const sPos = new Float32Array(9000);
        for(let i=0; i<9000; i++) sPos[i] = (Math.random()-0.5)*800;
        stars.setAttribute('position', new THREE.BufferAttribute(sPos, 3));
        scene.add(new THREE.Points(stars, new THREE.PointsMaterial({color:0xffffff, size:0.2, transparent:true})));

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
        window.addEventListener('click', onCanvasClick);
        animate();
    }

    function updateAsteroids(data) {
        // 1. Clear old asteroids from scene and memory
        asteroids.forEach(a => scene.remove(a.mesh));
        asteroids = [];

        data.forEach((neo, i) => {
            // --- TACTICAL ORBIT CALCULATION ---
            // Spread them out nicely between Earth (40) and Jupiter (75)
            // We use 'i' to ensure they don't all clump on top of each other
            let r = 45 + (i % 20) + (Math.random() * 10); 
            
            // --- BETTER GEOMETRY ---
            // Use Dodecahedron (12-sided) or Icosahedron with Detail 0 for chunky rock look
            // Hazardous ones are slightly larger/spikier
            const geometry = neo.hazardous 
                ? new THREE.IcosahedronGeometry(Math.max(0.4, neo.size_m/150), 0) // Spiky
                : new THREE.DodecahedronGeometry(Math.max(0.3, neo.size_m/150), 0); // Chunky

            // --- BETTER MATERIAL (The Secret Sauce) ---
            const material = new THREE.MeshStandardMaterial({
                color: neo.hazardous ? 0xff3b3b : 0x8899a6, // Bright Red or Blue-Grey Rock
                roughness: 0.9,  // Rocks are not shiny
                metalness: 0.1,  // Rocks are not metallic
                flatShading: true // <--- THIS MAKES THEM LOOK FACETED/ROCKY
            });

            const mesh = new THREE.Mesh(geometry, material);

            // --- DEFORMATION (Make them lumpy) ---
            // Randomly stretch x, y, z to make them imperfect
            mesh.scale.set(
                0.8 + Math.random() * 0.4, 
                0.8 + Math.random() * 0.4, 
                0.8 + Math.random() * 0.4
            );

            // --- POSITIONING ---
            const angle = Math.random() * Math.PI * 2;
            // Add some vertical spread (height) so they aren't on a flat disc
            const height = (Math.random() - 0.5) * 8; 
            
            mesh.position.set(Math.cos(angle)*r, height, Math.sin(angle)*r);
            
            // Random initial rotation so they don't all face the same way
            mesh.rotation.set(Math.random()*3, Math.random()*3, Math.random()*3);

            mesh.userData = { id: neo.id };
            scene.add(mesh);

            // Save for animation loop
            asteroids.push({ 
                mesh, 
                dist: r, 
                angle, 
                speed: 0.002 + Math.random() * 0.003, // Random orbit speed
                rotSpeed: { // Random tumble speed
                    x: (Math.random() - 0.5) * 0.02,
                    y: (Math.random() - 0.5) * 0.02
                }
            });
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        
        // Planet Animation
        planets.forEach(p => { 
            p.group.rotation.y += p.speed; 
            if(p.mesh) p.mesh.rotation.y += 0.02; 
        });

        // Asteroid Animation
        asteroids.forEach(a => {
            // 1. Orbit Move
            a.angle += a.speed;
            a.mesh.position.x = Math.cos(a.angle) * a.dist;
            a.mesh.position.z = Math.sin(a.angle) * a.dist;
            
            // 2. Self Tumble (New!)
            a.mesh.rotation.x += a.rotSpeed.x;
            a.mesh.rotation.y += a.rotSpeed.y;
        });

        if(controls) controls.update();
        if(renderer) renderer.render(scene, camera);
    }

    // --- 5. INTERACTIONS ---
    function handleObjectClick(id) {
        const neo = globalData.find(d => d.id === id);
        if(!neo) return;
        document.querySelectorAll('.mission-row').forEach(r => r.classList.remove('active'));
        document.getElementById(`row-${id}`)?.classList.add('active');
        const card = document.getElementById('detail-card');
        card.classList.remove('hidden', 'translate-x-[-20px]', 'opacity-0');
        
        document.getElementById('detail-name').innerText = neo.name;
        document.getElementById('detail-id').innerText = `ID: ${neo.id}`;
        document.getElementById('detail-dist').innerText = `${(neo.miss_distance_km/1000).toFixed(1)}K km`;
        document.getElementById('detail-vel').innerText = `${neo.velocity_kph.toFixed(0)} km/h`;
        document.getElementById('detail-size').innerText = `${Math.round(neo.size_m)} m`;
        document.getElementById('detail-risk-val').innerText = `${neo.risk_score}%`;
        document.getElementById('detail-risk-bar').style.width = `${neo.risk_score}%`;

        const target3D = asteroids.find(a => a.mesh.userData.id === id);
        if(target3D) {
            const vec = new THREE.Vector3(); target3D.mesh.getWorldPosition(vec);
            const camPos = vec.clone().normalize().multiplyScalar(vec.length()+8); camPos.y += 5;
            gsap.to(camera.position, { duration: 1.5, x: camPos.x, y: camPos.y, z: camPos.z });
            gsap.to(controls.target, { duration: 1.5, x: vec.x, y: vec.y, z: vec.z });
        }
    }

    function onCanvasClick(e) {
        if(e.target.tagName !== 'CANVAS') return;
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const hits = raycaster.intersectObjects(asteroids.map(a=>a.mesh));
        if(hits.length > 0) handleObjectClick(hits[0].object.userData.id);
    }

    function resetCamera(view) {
        if(view === 'solar') {
            gsap.to(camera.position, { duration: 2, x: 0, y: 100, z: 150 });
            gsap.to(controls.target, { duration: 2, x: 0, y: 0, z: 0 });
        } else if (view === 'earth') {
            const earth = planets.find(p => p.name === "Earth");
            if(earth) {
                const vec = new THREE.Vector3(); earth.mesh.getWorldPosition(vec);
                gsap.to(camera.position, { duration: 2, x: vec.x+10, y: vec.y+5, z: vec.z+10 });
                gsap.to(controls.target, { duration: 2, x: vec.x, y: vec.y, z: vec.z });
            }
        }
    }

    function updateRadar(data) {
        const el = document.getElementById('radar-blips');
        el.innerHTML = data.map(n => {
            const r = Math.min((n.miss_distance_km / 50000000) * 50, 48);
            const theta = Math.random() * 6.28;
            return `<div class="absolute w-1 h-1 rounded-full ${n.hazardous ? 'bg-red-500' : 'bg-cyan-500'}" style="top:${50+Math.sin(theta)*r}%; left:${50+Math.cos(theta)*r}%;"></div>`;
        }).join('');
    }

    function openAdminPrompt() {
        const uid = prompt("ENTER TARGET USER ID:");
        if(uid && currentUser) {
            fetch(`${API_URL}/community/approve`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ admin_id: currentUser.id, target_user_id: uid })
            }).then(res => res.json()).then(d => alert(JSON.stringify(d))).catch(e => alert(e));
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if(window.lucide) lucide.createIcons();
    });
    </script>
</body>
</html>