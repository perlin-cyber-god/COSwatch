<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Watch | Tactical Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-deep: #020408;
            --glass-panel: rgba(10, 15, 30, 0.75);
            --neon-cyan: #00f3ff;
            --hazard-red: #ff3b3b;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: white;
            margin: 0;
            overflow: hidden;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .syne { font-family: 'Syne', sans-serif; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .glass-panel {
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .mission-row:hover {
            background: rgba(0, 243, 255, 0.1);
            border-left: 2px solid var(--neon-cyan);
        }
        .mission-row.active {
            background: linear-gradient(90deg, rgba(0, 243, 255, 0.2) 0%, transparent 100%);
            border-left: 3px solid var(--neon-cyan);
        }
        .radar-sweep { animation: radar-spin 4s linear infinite; }
        @keyframes radar-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #auth-overlay { transition: opacity 0.8s ease; }
        body.locked main { filter: blur(15px); pointer-events: none; }
        /* --- 2D DATA VIEW (Tactical Grid) --- */
        #data-view-container {
            display: none; /* Hidden by default */
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a1a24 0%, #000000 100%);
            padding: 80px 40px; /* Space for UI panel */
            overflow-y: auto;
            z-index: 5;
            box-sizing: border-box;
            text-align: center;
        }

        .asteroid-2d {
            display: inline-block;
            margin: 20px;
            border-radius: 50%;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            cursor: pointer;
        }

        .asteroid-2d:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        /* The "Max Diameter" (Outer Shell) */
        .asteroid-shell {
            width: 100%; height: 100%;
            border-radius: 50%;
            opacity: 0.3;
            border: 1px dashed rgba(255,255,255,0.3);
        }

        /* The "Min Diameter" (Solid Core) */
        .asteroid-core {
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }

        /* HAZARDOUS STYLES */
        .hazard-true .asteroid-shell {
            background-color: rgba(255, 0, 0, 0.1);
            border-color: #ff3333;
            box-shadow: 0 0 20px #ff0000;
        }
        .hazard-true .asteroid-core {
            background: linear-gradient(135deg, #800000, #ff0000);
            border: 1px solid #ff9999;
        }
        /* --- UPGRADED 2D VIEW STYLES --- */
        .analysis-header {
            max-width: 800px;
            margin: 0 auto 40px auto;
            text-align: left;
            border-left: 2px solid var(--neon-cyan);
            padding-left: 20px;
            background: linear-gradient(90deg, rgba(0, 243, 255, 0.1) 0%, transparent 100%);
        }

        .filter-bar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.2);
            color: #8899a6;
            padding: 8px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        .filter-btn:hover, .filter-btn.active {
            background: rgba(0, 243, 255, 0.2);
            border-color: var(--neon-cyan);
            color: white;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }

        /* SPEED TAILS */
        .velocity-tail {
            position: absolute;
            top: 50%; left: 50%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5));
            transform-origin: left center;
            z-index: -1;
        }

        /* IMPACT INFO BOX */
        .impact-info {
            font-size: 9px;
            color: #aaa;
            margin-top: 4px;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 4px;
        }
        
        /* SCALE REFERENCE MARKER */
        .scale-ref {
            position: absolute;
            bottom: 10px; right: 10px;
            height: 100px; width: 2px;
            background: white;
            display: none; /* Toggled via JS */
        }
        .scale-ref::after {
            content: "EIFFEL TOWER (330m)";
            position: absolute;
            bottom: 0; right: 5px;
            font-size: 9px;
            white-space: nowrap;
            color: white;
        }

        /* SAFE STYLES */
        .hazard-false .asteroid-shell {
            background-color: rgba(0, 200, 255, 0.05);
            border-color: #00ccff;
            box-shadow: 0 0 10px #00ccff;
        }
        .hazard-false .asteroid-core {
            background: linear-gradient(135deg, #333344, #556677);
            border: 1px solid #8899aa;
        }

        /* INFO LABEL (Appears on Hover) */
        .asteroid-label {
            position: absolute;
            bottom: -30px; left: 50%;
            transform: translateX(-50%);
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            background: rgba(0,0,0,0.8);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .asteroid-2d:hover .asteroid-label {
            opacity: 1;
        }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden locked">

    <div id="auth-overlay" class="fixed inset-0 z-[999] bg-black/90 backdrop-blur-xl flex items-center justify-center">
        <div class="w-[400px] border border-white/10 bg-black/80 p-8 rounded-xl shadow-[0_0_50px_rgba(0,255,255,0.1)] relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent"></div>
            
            <div class="text-center mb-8">
                <h1 class="syne text-3xl uppercase tracking-widest text-white mb-2">Cosmic<span class="text-cyan-500">Watch</span></h1>
                <p class="mono text-[10px] text-slate-500 uppercase tracking-[0.2em]">Restricted Access // Sector 7</p>
            </div>

            <div class="space-y-4">
                <div class="space-y-2">
                    <input id="auth-email" type="email" placeholder="OPERATOR ID (EMAIL)" class="w-full bg-white/5 border border-white/10 p-3 text-xs mono text-white focus:border-cyan-500 outline-none transition-colors">
                    <input id="auth-pass" type="password" placeholder="ACCESS KEY" class="w-full bg-white/5 border border-white/10 p-3 text-xs mono text-white focus:border-cyan-500 outline-none transition-colors">
                </div>
                
                <div id="auth-error" class="hidden text-red-500 text-[10px] mono text-center uppercase tracking-widest animate-pulse">
                    INVALID CREDENTIALS
                </div>
                <div id="signup-msg" class="hidden text-cyan-400 text-[10px] mono text-center uppercase tracking-widest"></div>

                <div class="grid grid-cols-2 gap-3">
                    <button id="login-btn" onclick="handleLogin()" class="bg-cyan-600 hover:bg-cyan-500 text-white py-3 text-xs font-bold uppercase tracking-widest transition-all">
                        Login
                    </button>
                    <button id="signup-btn" onclick="handleSignUp()" class="border border-white/20 hover:bg-white/5 text-slate-300 py-3 text-xs font-bold uppercase tracking-widest transition-all">
                        Sign Up
                    </button>
                </div>

                <div class="relative py-2"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div><span class="relative bg-black px-2 text-[9px] text-slate-500 mono uppercase block text-center">OR</span></div>
                
                <button onclick="handleGuest()" class="w-full py-2 text-[10px] text-slate-500 hover:text-cyan-400 mono uppercase tracking-widest transition-colors">
                    Initialize Guest Protocol
                </button>
            </div>
        </div>
    </div>

    <aside class="w-[380px] flex-shrink-0 bg-black/90 border-r border-white/10 flex flex-col z-20 relative">
        <div class="p-6 border-b border-white/10 bg-gradient-to-r from-slate-900 to-black">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_lime]"></div>
                <span class="text-[10px] mono uppercase tracking-[0.2em] text-slate-400">Live Telemetry</span>
            </div>
            <h1 class="syne text-3xl uppercase tracking-tighter leading-none">
                Cosmic<br/><span class="text-cyan-400">Watch</span>
            </h1>
            
            <div class="grid grid-cols-2 gap-2 mt-6">
                <div class="bg-white/5 p-3 rounded border border-white/5">
                    <span class="block text-[9px] mono text-slate-500 uppercase">Tracked Objects</span>
                    <span id="stat-objects" class="text-2xl font-bold mono">--</span>
                </div>
                <div class="bg-white/5 p-3 rounded border border-white/5">
                    <span class="block text-[9px] mono text-slate-500 uppercase">Highest Risk</span>
                    <span id="stat-risk" class="text-2xl font-bold mono text-yellow-500">--%</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto">
            <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 bg-black z-10 text-[10px] mono uppercase text-slate-500 border-b border-white/10">
                    <tr>
                        <th class="p-3 pl-6 font-normal">Designation</th>
                        <th class="p-3 pr-6 font-normal text-right">Hazard %</th>
                    </tr>
                </thead>
                <tbody id="neo-table-body"></tbody>
            </table>
        </div>

        <div class="p-3 border-t border-white/10 bg-black text-[10px] mono text-slate-600 flex justify-between items-center">
            <span id="status-indicator">AWAITING AUTH...</span>
            <span id="user-tier-badge" class="px-2 py-0.5 rounded bg-slate-800 text-slate-400">LOCKED</span>
        </div>
    </aside>

    <main class="flex-1 relative bg-black">
        <div id="visualization-container" class="absolute inset-0 z-0"></div>
        <div id="data-view-container"></div>

        <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-10 pointer-events-none">
            <div class="pointer-events-auto flex gap-2">
                <button id="view-toggle" onclick="toggleView()" class="text-xs bg-white/5 text-slate-400 px-3 py-1 border border-white/10 hover:text-white hover:border-cyan-500 transition-all">ANALYSIS VIEW</button>
                <button onclick="resetCamera('solar')" class="text-xs bg-white/5 text-slate-400 px-3 py-1 border border-white/10 hover:text-white hover:border-cyan-500">SYSTEM VIEW</button>
                <button onclick="resetCamera('earth')" class="text-xs bg-white/5 text-slate-400 px-3 py-1 border border-white/10 hover:text-white hover:border-cyan-500">EARTH VIEW</button>
            </div>
            <div class="flex flex-col items-end pointer-events-auto gap-4">
                 <button onclick="fetchNEOData()" class="text-cyan-500 hover:text-white transition-colors bg-white/5 p-2 rounded-full border border-white/10 hover:bg-cyan-500/20">
                    <i data-lucide="refresh-cw" size="18"></i>
                </button>
                <button id="admin-btn" onclick="openAdminPrompt()" class="hidden px-4 py-2 bg-red-500/10 border border-red-500/50 text-red-400 mono text-[10px] uppercase tracking-widest hover:bg-red-500 hover:text-white transition-all">
                    <i data-lucide="shield-alert" size="14" class="inline mr-1"></i> Admin Panel
                </button>
            </div>
        </div>

        <div id="detail-card" class="absolute top-24 left-8 w-[400px] glass-panel rounded-xl p-6 hidden z-20 pointer-events-auto transform transition-all duration-500 translate-x-[-20px] opacity-0">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span id="detail-id" class="text-[10px] mono text-cyan-500 uppercase tracking-widest">NEO-ID</span>
                        <div id="detail-hazard-badge" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-800 text-slate-400">Analyzing</div>
                    </div>
                    <h2 id="detail-name" class="syne text-4xl text-white leading-none tracking-tight">Object</h2>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="space-y-1">
                    <span class="text-[9px] mono text-slate-500 uppercase">Diameter</span>
                    <p id="detail-size" class="text-xl font-mono text-white">---</p>
                </div>
                <div class="space-y-1">
                    <span class="text-[9px] mono text-slate-500 uppercase">Velocity</span>
                    <p id="detail-vel" class="text-xl font-mono text-cyan-400">---</p>
                </div>
                <div class="space-y-1 col-span-2">
                    <span class="text-[9px] mono text-slate-500 uppercase">Miss Distance</span>
                    <p id="detail-dist" class="text-2xl font-mono text-white">---</p>
                </div>
            </div>

            <div class="mb-4 bg-white/5 p-3 rounded border border-white/5">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-[10px] mono text-slate-400 uppercase tracking-widest">Impact Probability</span>
                    <span id="detail-risk-val" class="text-xl font-bold text-white">0%</span>
                </div>
                <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                    <div id="detail-risk-bar" class="h-full bg-cyan-500 transition-all duration-1000 w-0"></div>
                </div>
            </div>
        </div>

        <div class="absolute top-24 right-8 z-20 pointer-events-auto flex flex-col items-center gap-2">
            <div class="relative w-72 h-72 rounded-full border border-white/20 bg-black/60 backdrop-blur-md flex items-center justify-center shadow-[0_0_50px_rgba(0,0,0,0.8)] overflow-hidden">
                <div class="absolute inset-0 border rounded-full border-white/10 scale-75"></div>
                <div class="absolute inset-0 border rounded-full border-white/5 scale-50"></div>
                <div class="absolute w-full h-[1px] bg-white/10 top-1/2"></div>
                <div class="absolute h-full w-[1px] bg-white/10 left-1/2"></div>
                <div class="absolute w-1/2 h-1/2 top-0 left-0 origin-bottom-right radar-sweep border-r border-cyan-500/30 bg-gradient-to-l from-cyan-500/10 to-transparent"></div>
                <div id="radar-blips" class="absolute inset-0 w-full h-full"></div>
                <div class="absolute w-2 h-2 bg-cyan-400 rounded-full shadow-[0_0_10px_cyan] z-10"></div>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse"></span>
                <span class="text-[9px] mono text-cyan-400/80 uppercase tracking-widest">Active Scan // 50M KM</span>
            </div>
        </div>

    </main>

    <script>
    // --- 1. CONFIGURATION ---
    const SB_URL = "https://toamgacouwrwtibzbwyo.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvYW1nYWNvdXdyd3RpYnpid3lvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MzMwMzIsImV4cCI6MjA4NjAwOTAzMn0.RF1k9QJG6sL6N1CBwPfHH-Zv0Jou1Lh3202dHolkmL0";
    
    // SAFE VARIABLE NAME: sbClient
    const sbClient = supabase.createClient(SB_URL, SB_KEY);
    
    const API_URL = 'http://127.0.0.1:8000';
    const MOCK_DATA = [
        { name: "99942 Apophis", hazardous: true, velocity_kph: 30720, miss_distance_km: 31000, risk_score: 96, estimated_diameter: { meters: { estimated_diameter_max: 370 } } },
        { name: "2024 FG3", hazardous: false, velocity_kph: 15400, miss_distance_km: 12000000, risk_score: 5, estimated_diameter: { meters: { estimated_diameter_max: 22 } } }
    ];

    let scene, camera, renderer, controls;
    let asteroids = [];
    let planets = []; 
    let globalData = []; 
    let raycaster = new THREE.Raycaster();
    let mouse = new THREE.Vector2();
    let currentUser = null;

    // --- 2. AUTH FLOW ---
    async function handleLogin() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        const btn = document.getElementById('login-btn');
        const err = document.getElementById('auth-error');

        if (!email || !password) return;

        btn.innerText = "VERIFYING...";
        btn.disabled = true;
        err.classList.add('hidden');

        const { data, error } = await sbClient.auth.signInWithPassword({ email, password });

        if (error) {
            err.innerText = error.message.toUpperCase();
            err.classList.remove('hidden');
            btn.innerText = "LOGIN";
            btn.disabled = false;
        } else {
            await syncUserWithBackend(data.user.id);
        }
    }
    // --- NEW: BLUE POINTER ON EARTH ---
    function addEarthPointer(lat, lon) {
        const earthObj = planets.find(p => p.name === "Earth");
        if (!earthObj) return;

        // Earth is at earthObj.mesh.position (which is x=40, y=0, z=0 usually)
        // But the mesh itself is rotated. We need to attach the pointer TO the Earth mesh
        // so it spins WITH the Earth.

        // 1. The Marker Geometry (A thin glowing stick)
        const geometry = new THREE.CylinderGeometry(0.02, 0.02, 0.8, 8);
        const material = new THREE.MeshBasicMaterial({ 
            color: 0x00f3ff, // Neon Blue
            transparent: true,
            opacity: 0.8
        });
        
        const pointer = new THREE.Mesh(geometry, material);
        
        // 2. Calculate Position on Surface (Radius is 1.6)
        // We use lat/lon 0,0 for now, or whatever you pass
        const pos = getEarthPosition(lat, lon, 1.6); // 1.6 is Earth's radius in your code
        
        pointer.position.copy(pos);
        
        // 3. Orient the pointer to stick OUT of the earth
        pointer.lookAt(new THREE.Vector3(0,0,0)); // Look at center of earth
        pointer.rotateX(Math.PI / 2); // Rotate 90deg so the cylinder points out
        
        // 4. Add to Earth MESH (so it rotates with the planet)
        earthObj.mesh.add(pointer);
        
        // 5. Add a glowing ring at the base
        const ringGeo = new THREE.RingGeometry(0.04, 0.06, 32);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0x00f3ff, side: THREE.DoubleSide });
        const ring = new THREE.Mesh(ringGeo, ringMat);
        ring.position.copy(pos.clone().multiplyScalar(1.01)); // Slightly above surface
        ring.lookAt(new THREE.Vector3(0,0,0));
        earthObj.mesh.add(ring);
    }

    async function handleSignUp() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        const btn = document.getElementById('signup-btn');
        const msg = document.getElementById('signup-msg');
        const err = document.getElementById('auth-error');

        if(!email || !password) {
            err.innerText = "ENTER CREDENTIALS";
            err.classList.remove('hidden');
            return;
        }

        btn.innerText = "CREATING...";
        btn.disabled = true;

        const { data, error } = await sbClient.auth.signUp({ email, password });

        if (error) {
            err.innerText = error.message.toUpperCase();
            err.classList.remove('hidden');
            btn.innerText = "SIGN UP";
            btn.disabled = false;
        } else {
            msg.innerText = "ACCOUNT CREATED. LOGGING IN...";
            msg.classList.remove('hidden');
            if(data.session) {
                await syncUserWithBackend(data.user.id);
            } else {
                msg.innerText = "CONFIRM EMAIL TO CONTINUE";
            }
        }
    }

    async function syncUserWithBackend(userId) {
        try {
            console.log("Initializing User on Backend:", userId);
            const response = await fetch(`${API_URL}/user/init`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });
            
            if(!response.ok) throw new Error("Backend handshake failed");
            
            const result = await response.json();
            const tier = result.tier || 'researcher'; 
            
            unlockDashboard(tier.toUpperCase());
        } catch (e) {
            console.error("Sync Error:", e);
            unlockDashboard('RESEARCHER (OFFLINE)'); 
        }
    }

    function handleGuest() {
        unlockDashboard('GUEST');
    }

    function unlockDashboard(role) {
        const overlay = document.getElementById('auth-overlay');
        overlay.style.opacity = '0';
        setTimeout(() => overlay.remove(), 800);
        document.body.classList.remove('locked');

        document.getElementById('status-indicator').innerHTML = `<span class="text-cyan-400 font-bold animate-pulse">‚óè SYSTEM ONLINE</span>`;
        document.getElementById('user-tier-badge').innerText = role;

        if (role === 'ADMIN') document.getElementById('admin-btn').classList.remove('hidden');

        init3D();
        fetchNEOData();
    }

    // --- 3. DATA LOGIC ---
    // --- 3. DATA LOGIC (DEBUG MODE) ---
    async function fetchNEOData() {
        console.group("üöÄ STARTING NEO DATA FETCH");
        console.time("Fetch Duration");

        try {
            const url = `${API_URL}/neo/feed`;
            console.log(`üì° Dialing Backend: ${url}`);

            const res = await fetch(url);
            
            console.log(`DATA STATUS: ${res.status} ${res.statusText}`);
            
            if (!res.ok) {
                throw new Error(`Server responded with ${res.status}`);
            }

            const rawData = await res.json();
            console.log("üì¶ Raw Payload Received:", rawData);

            // CHECK: Is it an array (our processed list) or NASA raw JSON?
            let processed = [];
            
            if (Array.isArray(rawData)) {
                console.log(`‚úÖ Backend returned Clean Array of ${rawData.length} objects`);
                processed = rawData;
            } else if (rawData.near_earth_objects) {
                console.warn("‚ö†Ô∏è Backend returned RAW NASA JSON (Not Processed). Processing manually...");
                // Flatten the date-based structure if needed
                Object.values(rawData.near_earth_objects).forEach(dayList => {
                    processed = processed.concat(dayList);
                });
            } else {
                console.error("‚ùå Data format unrecognized:", rawData);
            }

            // FALLBACK CHECK
            if (processed.length === 0) {
                console.warn("‚ö†Ô∏è Data empty. Switching to Emergency Mock Data.");
                processed = MOCK_DATA;
            }

            // LOG THE FIRST ITEM TO VERIFY STRUCTURE
            if (processed.length > 0) {
                console.log("üßê Inspecting First Object:", processed[0]);
                // Check if 'estimated_diameter' exists
                if (!processed[0].estimated_diameter && !processed[0].size_m) {
                    console.error("‚ùå CRITICAL: 'estimated_diameter' or 'size_m' missing! Asteroids will be invisible.");
                }
            }

            // Map to our app format
            // ... inside fetchNEOData ...
            globalData = processed.map((obj, i) => {
                // Diameter Logic
                let diam = 50; 
                let minDiam = 30; // Default fallback

                if (obj.size_m) {
                    diam = obj.size_m;
                    minDiam = diam * 0.7;
                }
                else if (obj.estimated_diameter?.meters?.estimated_diameter_max) {
                    diam = obj.estimated_diameter.meters.estimated_diameter_max;
                    minDiam = obj.estimated_diameter.meters.estimated_diameter_min;
                }

                let vel = parseFloat(obj.velocity_kph) || 
                          parseFloat(obj.close_approach_data?.[0]?.relative_velocity?.kilometers_per_hour) || 0;
                
                let dist = parseFloat(obj.miss_distance_km) || 
                           parseFloat(obj.close_approach_data?.[0]?.miss_distance?.kilometers) || 0;

                return {
                    id: obj.id || `neo-${i}`,
                    name: obj.name || "Unknown",
                    velocity_kph: vel,
                    miss_distance_km: dist,
                    size_m: diam,
                    raw_diameter_min: minDiam, // <--- NEW FIELD FOR 2D VIEW
                    raw_diameter_max: diam,    // <--- NEW FIELD FOR 2D VIEW
                    hazardous: obj.hazardous || obj.is_potentially_hazardous_asteroid || false,
                    risk_score: obj.risk_score || (obj.is_potentially_hazardous_asteroid ? 85 : 5)
                };
            });

            console.log(`‚úÖ Final Parsed Data: ${globalData.length} objects ready for 3D.`);
            
            // UI UPDATES
            globalData.sort((a, b) => b.risk_score - a.risk_score);
            updateUI(globalData);
            updateAsteroids(globalData); // <--- This calls the 3D update
            updateRadar(globalData);

        } catch (e) {
            console.error("üö® FATAL FETCH ERROR:", e);
            console.warn("‚ö†Ô∏è System Offline. Loading Simulation Data.");
            
            // LOAD MOCK DATA SO APP DOESN'T CRASH
            globalData = MOCK_DATA.map((obj, i) => ({
                id: `mock-${i}`,
                name: obj.name,
                velocity_kph: obj.velocity_kph,
                miss_distance_km: obj.miss_distance_km,
                size_m: obj.estimated_diameter.meters.estimated_diameter_max,
                hazardous: obj.hazardous,
                risk_score: obj.risk_score
            }));
            updateUI(globalData);
            updateAsteroids(globalData);
            updateRadar(globalData);
        }
        
        console.timeEnd("Fetch Duration");
        console.groupEnd();
    }
    function updateUI(data) {
        document.getElementById('stat-objects').innerText = data.length;
        document.getElementById('stat-risk').innerText = Math.max(...data.map(d=>d.risk_score||0)) + "%";
        document.getElementById('neo-table-body').innerHTML = data.map(neo => `
            <tr onclick="handleObjectClick('${neo.id}')" id="row-${neo.id}" class="mission-row cursor-pointer transition-colors border-b border-white/5">
                <td class="p-3 pl-6">
                    <div class="flex flex-col">
                        <span class="font-bold text-sm text-slate-200">${neo.name}</span>
                        <span class="text-[9px] mono text-slate-600 tracking-widest">ID: ${neo.id.split('-')[1]}</span>
                    </div>
                </td>
                <td class="p-3 pr-6 text-right">
                    <span class="mono text-xs font-bold ${neo.risk_score >= 70 ? 'text-red-500' : 'text-cyan-500'}">${neo.risk_score}%</span>
                </td>
            </tr>
        `).join('');
    }
    // --- HELPER: GENERATE GLOW TEXTURE (No more 404s) ---
function createGlowTexture() {
    const canvas = document.createElement('canvas');
    canvas.width = 32; canvas.height = 32;
    const context = canvas.getContext('2d');
    const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
    gradient.addColorStop(0, 'rgba(255, 170, 0, 1)'); // Center Color
    gradient.addColorStop(0.2, 'rgba(255, 170, 0, 0.6)');
    gradient.addColorStop(0.5, 'rgba(255, 100, 0, 0.2)');
    gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); // Outer Transparent
    context.fillStyle = gradient;
    context.fillRect(0, 0, 32, 32);
    const texture = new THREE.CanvasTexture(canvas);
    return texture;
}
    // --- HELPER: Lat/Lon to 3D Position ---
    function getEarthPosition(lat, lon, radius) {
        const phi = (90 - lat) * (Math.PI / 180);
        const theta = (lon + 180) * (Math.PI / 180);
        
        const x = -(radius * Math.sin(phi) * Math.cos(theta));
        const z = (radius * Math.sin(phi) * Math.sin(theta));
        const y = (radius * Math.cos(phi));
        
        return new THREE.Vector3(x, y, z);
    }

    // --- 4. 3D SOLAR SYSTEM ---
    function init3D() {
        const container = document.getElementById('visualization-container');
        if (container.children.length > 0) return; 

        scene = new THREE.Scene();
        // 1. LIGHTING UPGRADE: Brighter, slightly blue-tinted fog for depth
        scene.fog = new THREE.FogExp2(0x020205, 0.002); 

        camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 20000); 
        camera.position.set(0, 100, 150); 
        
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping; 
        renderer.toneMappingExposure = 1.3; 
        container.appendChild(renderer.domElement);
        
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        // --- 2. SUPER BRIGHT SUN & AMBIENT ---
        const ambientLight = new THREE.AmbientLight(0x606080, 1.2); 
        scene.add(ambientLight);

        const sunLight = new THREE.PointLight(0xffaa00, 5.0, 3000);
        sunLight.position.set(0, 0, 0);
        scene.add(sunLight);

        // --- 3. MULTI-LAYER STAR SYSTEM ---
        function createStarLayer(count, size, color, spread) {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(count * 3);
            for(let i = 0; i < count * 3; i++) {
                positions[i] = (Math.random() - 0.5) * spread;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const material = new THREE.PointsMaterial({
                size: size,
                color: color,
                transparent: true,
                opacity: 0.8 + Math.random() * 0.2,
                sizeAttenuation: true,
                blending: THREE.AdditiveBlending
            });
            return new THREE.Points(geometry, material);
        }

        // Layer 1: "Star Dust"
        scene.add(createStarLayer(15000, 0.6, 0x8888aa, 5000));
        // Layer 2: "Main Stars"
        scene.add(createStarLayer(4000, 1.5, 0xffffff, 4000));
        // Layer 3: "Giants"
        scene.add(createStarLayer(500, 3.5, 0xaaddff, 4000));


        // --- SOLAR SYSTEM OBJECTS ---
        // Sun Mesh 
        const sun = new THREE.Mesh(
            new THREE.SphereGeometry(10, 64, 64), 
            new THREE.MeshBasicMaterial({ color: 0xffaa00 }) 
        );
        scene.add(sun);
        
        // Giant Glow Sprite (Using the Helper Function)
        const spriteMaterial = new THREE.SpriteMaterial({ 
            map: createGlowTexture(), 
            color: 0xffaa00, 
            transparent: true, 
            blending: THREE.AdditiveBlending,
            opacity: 1.0 
        });
        const sprite = new THREE.Sprite(spriteMaterial);
        sprite.scale.set(60, 60, 1.0); 
        sun.add(sprite);

        // Planets Setup
        const systemData = [
            { name: "Mercury", color: 0xaaaaaa, size: 0.8, dist: 20, speed: 0.02 },
            { name: "Venus", color: 0xffcc00, size: 1.5, dist: 30, speed: 0.015 },
            { name: "Earth", color: 0x2233ff, size: 1.6, dist: 40, speed: 0.01 },
            { name: "Mars", color: 0xff4422, size: 1.2, dist: 50, speed: 0.008 },
            { name: "Jupiter", color: 0xdcae96, size: 4.0, dist: 75, speed: 0.004 },
            { name: "Saturn", color: 0xf4d03f, size: 3.5, dist: 95, speed: 0.003, ring: true },
            { name: "Uranus", color: 0x4fd0e7, size: 2.5, dist: 115, speed: 0.002 },
            { name: "Neptune", color: 0x3e54e8, size: 2.4, dist: 130, speed: 0.001 }
        ];

        systemData.forEach(p => {
            const pGroup = new THREE.Group();
            
            // Planet Mesh
            const mesh = new THREE.Mesh(
                new THREE.SphereGeometry(p.size, 32, 32), 
                new THREE.MeshStandardMaterial({ 
                    color: p.color,
                    roughness: 0.6,
                    metalness: 0.1,
                    emissive: p.color,
                    emissiveIntensity: 0.1
                })
            );
            mesh.position.x = p.dist;
            pGroup.add(mesh);
            
            // Rings
            if (p.ring) {
                const ring = new THREE.Mesh(
                    new THREE.TorusGeometry(p.size+1.5, 0.5, 2, 64), 
                    new THREE.MeshStandardMaterial({ 
                        color: 0xccaa88, 
                        transparent: true, 
                        opacity: 0.8,
                        side: THREE.DoubleSide
                    })
                );
                ring.rotation.x = Math.PI/2;
                ring.position.x = p.dist;
                pGroup.add(ring);
            }
            
            // Orbit Lines
            const orbit = new THREE.Line(
                new THREE.BufferGeometry().setFromPoints(new THREE.EllipseCurve(0,0, p.dist, p.dist, 0, 2*Math.PI, false, 0).getPoints(128)),
                new THREE.LineBasicMaterial({color: 0xffffff, transparent:true, opacity:0.25})
            );
            orbit.rotation.x = Math.PI/2;
            scene.add(orbit);
            scene.add(pGroup);
            planets.push({ group: pGroup, speed: p.speed, name: p.name, mesh });
        });

        // --- ADD POINTER TO EARTH (New Delhi) ---
        // This function must be defined outside init3D
        addEarthPointer(28.6139, 77.2090); 

        // Event Listeners
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        window.addEventListener('click', onCanvasClick);
        animate();
    }

    // --- 5. UPDATED ASTEROID LOGIC (Tactical Scale: 12x Larger) ---
    // --- 5. UPDATED ASTEROID LOGIC (2.5x Size, Solid Rock Shapes) ---
    // --- 5. UPDATED ASTEROID LOGIC (Data-Driven, Deterministic, No Random) ---
    // --- 5. UPDATED ASTEROID LOGIC (Scientifically Clamped to Earth Zone) ---
    function updateAsteroids(data) {
        asteroids.forEach(a => scene.remove(a.mesh));
        asteroids = [];

        const seed = (id) => {
            let h = 0x811c9dc5;
            for(let i = 0; i < id.length; i++) h = Math.imul(h ^ id.charCodeAt(i), 0x01000193);
            return ((h >>> 0) / 4294967296); 
        };

        data.forEach((neo, i) => {
            // --- ORBITAL FIX ---
            // Earth is at 40 units.
            // NEOs are "Near Earth", so they must be close to 40.
            // Previous error: allowed them to drift to 20 (Mercury).
            // New Logic: Clamp them to the "Goldilocks Zone" (0.9AU - 1.3AU)
            
            const earthPos = 40; 
            const variation = seed(neo.id + "dist"); // 0 to 1
            
            // This puts them between 36 (Just inside Earth) and 52 (Just past Mars)
            // They will act as a "Cloud" surrounding Earth's orbit, which is accurate for NEOs.
            let orbitR = 36 + (variation * 16); 

            // Speed: Faster if closer to sun (Kepler's Law approx)
            const speed = 0.0005 + (1 / orbitR) * 0.05;

            // Inclination: NEOs are often tilted relative to planets
            const inclination = (seed(neo.id + "inc") - 0.5) * 0.5; // +/- 0.25 rad

            // Start Angle (Random placement in the ring)
            const angle = seed(neo.id + "angle") * Math.PI * 2;

            // --- VISUALS ---
            let rawSize = (neo.size_m / 150); 
            let tacticalSize = Math.max(0.4, Math.min(2.0, rawSize * 2.5));

            const geometry = new THREE.DodecahedronGeometry(tacticalSize, 0);
            const posAttribute = geometry.attributes.position;
            const temp = new THREE.Vector3();

            for (let v = 0; v < posAttribute.count; v++) {
                temp.fromBufferAttribute(posAttribute, v);
                const noise = 1.0 + Math.sin(temp.x * 3.0) * 0.2 + Math.cos(temp.y * 3.0) * 0.2; 
                temp.multiplyScalar(noise);
                posAttribute.setXYZ(v, temp.x, temp.y, temp.z);
            }
            geometry.computeVertexNormals();

            const material = new THREE.MeshStandardMaterial({
                color: neo.hazardous ? 0xff4d4d : 0x778899,
                roughness: 0.8,
                metalness: 0.2,
                flatShading: true,
                emissive: neo.hazardous ? 0x220000 : 0x000000,
                emissiveIntensity: 0.2
            });

            const mesh = new THREE.Mesh(geometry, material);

            // Initial Position
            const x = Math.cos(angle) * orbitR;
            const z = Math.sin(angle) * orbitR;
            const y = Math.sin(angle) * orbitR * Math.sin(inclination);

            mesh.position.set(x, y, z);
            mesh.userData = { id: neo.id };
            
            scene.add(mesh);

            asteroids.push({ 
                mesh, 
                dist: orbitR, 
                angle: angle, 
                inclination: inclination,
                speed: speed, 
                rotSpeed: {
                    x: (seed(neo.id + "rx") - 0.5) * 0.02,
                    y: (seed(neo.id + "ry") - 0.5) * 0.02,
                    z: (seed(neo.id + "rz") - 0.5) * 0.02
                }
            });
        });
    }

    // --- 6. ANIMATION LOOP (Fixed: Unified Prograde Direction) ---
    // --- 6. ANIMATION LOOP (Synchronized Orbits) ---
    function animate() {
        requestAnimationFrame(animate);

        // A. PLANETS (The Reference Flow)
        // ---------------------------------------------------------
        planets.forEach(p => {
            // Orbit: Counter-Clockwise flow
            if (p.group) {
                p.group.rotation.y += p.speed; 
            }

            // Spin: Day/Night Cycle
            if (p.mesh) {
                // Venus/Uranus Spin Backwards (Retrograde)
                if (p.name === "Venus" || p.name === "Uranus") {
                    p.mesh.rotation.y -= 0.005; 
                } else {
                    p.mesh.rotation.y += 0.005; 
                }
            }
        });

        // B. ASTEROIDS (Aligned to Planet Flow)
        // ---------------------------------------------------------
        asteroids.forEach(a => {
            // FIX: We SUBTRACT speed to match the Three.js rotation matrix direction
            // Previous: += (Opposite to planets) -> Now: -= (Same as planets)
            a.angle -= a.speed; 

            // Calculate Position
            // The logic remains standard circle math, but since angle is decreasing,
            // the direction of travel flips to match the planets.
            const x = Math.cos(a.angle) * a.dist;
            const z = Math.sin(a.angle) * a.dist;
            
            // Vertical Tilt (Inclination)
            const y = Math.sin(a.angle) * a.dist * Math.sin(a.inclination);

            // Update Mesh
            a.mesh.position.set(x, y, z);

            // Tumble the Rock
            a.mesh.rotation.x += a.rotSpeed.x;
            a.mesh.rotation.y += a.rotSpeed.y;
            a.mesh.rotation.z += a.rotSpeed.z;
        });

        // C. RENDER
        // ---------------------------------------------------------
        controls.update();
        renderer.render(scene, camera);
    }

    // --- 5. INTERACTIONS ---
    function handleObjectClick(id) {
        const neo = globalData.find(d => d.id === id);
        if(!neo) return;
        document.querySelectorAll('.mission-row').forEach(r => r.classList.remove('active'));
        document.getElementById(`row-${id}`)?.classList.add('active');
        const card = document.getElementById('detail-card');
        card.classList.remove('hidden', 'translate-x-[-20px]', 'opacity-0');
        
        document.getElementById('detail-name').innerText = neo.name;
        document.getElementById('detail-id').innerText = `ID: ${neo.id}`;
        document.getElementById('detail-dist').innerText = `${(neo.miss_distance_km/1000).toFixed(1)}K km`;
        document.getElementById('detail-vel').innerText = `${neo.velocity_kph.toFixed(0)} km/h`;
        document.getElementById('detail-size').innerText = `${Math.round(neo.size_m)} m`;
        document.getElementById('detail-risk-val').innerText = `${neo.risk_score}%`;
        document.getElementById('detail-risk-bar').style.width = `${neo.risk_score}%`;

        const target3D = asteroids.find(a => a.mesh.userData.id === id);
        if(target3D) {
            const vec = new THREE.Vector3(); target3D.mesh.getWorldPosition(vec);
            const camPos = vec.clone().normalize().multiplyScalar(vec.length()+8); camPos.y += 5;
            gsap.to(camera.position, { duration: 1.5, x: camPos.x, y: camPos.y, z: camPos.z });
            gsap.to(controls.target, { duration: 1.5, x: vec.x, y: vec.y, z: vec.z });
        }
    }

    function onCanvasClick(e) {
        if(e.target.tagName !== 'CANVAS') return;
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const hits = raycaster.intersectObjects(asteroids.map(a=>a.mesh));
        if(hits.length > 0) handleObjectClick(hits[0].object.userData.id);
    }

    function resetCamera(view) {
        if(view === 'solar') {
            gsap.to(camera.position, { duration: 2, x: 0, y: 100, z: 150 });
            gsap.to(controls.target, { duration: 2, x: 0, y: 0, z: 0 });
        } else if (view === 'earth') {
            const earth = planets.find(p => p.name === "Earth");
            if(earth) {
                const vec = new THREE.Vector3(); earth.mesh.getWorldPosition(vec);
                gsap.to(camera.position, { duration: 2, x: vec.x+10, y: vec.y+5, z: vec.z+10 });
                gsap.to(controls.target, { duration: 2, x: vec.x, y: vec.y, z: vec.z });
            }
        }
    }

    function updateRadar(data) {
        const el = document.getElementById('radar-blips');
        el.innerHTML = data.map(n => {
            const r = Math.min((n.miss_distance_km / 50000000) * 50, 48);
            const theta = Math.random() * 6.28;
            return `<div class="absolute w-1 h-1 rounded-full ${n.hazardous ? 'bg-red-500' : 'bg-cyan-500'}" style="top:${50+Math.sin(theta)*r}%; left:${50+Math.cos(theta)*r}%;"></div>`;
        }).join('');
    }
    // --- NEW: 2D VIEW LOGIC ---
    let is3DView = true;

    function toggleView() {
        const view3D = document.getElementById('visualization-container');
        const view2D = document.getElementById('data-view-container');
        const btn = document.getElementById('view-toggle');

        is3DView = !is3DView;

        if (is3DView) {
            view3D.style.display = 'block';
            view2D.style.display = 'none';
            btn.innerText = "ANALYSIS VIEW";
            btn.style.background = "";
            btn.style.borderColor = "";
            btn.style.color = "";
        } else {
            view3D.style.display = 'none';
            view2D.style.display = 'block';
            btn.innerText = "RETURN TO ORBIT";
            btn.style.background = "rgba(0, 243, 255, 0.1)";
            btn.style.borderColor = "#00f3ff";
            btn.style.color = "#00f3ff";
            
            // Render grid if empty
            if (view2D.innerHTML === "") {
                render2DView(globalData);
            }
        }
    }

    // --- ADVANCED 2D ANALYSIS LOGIC ---
    
    // State for the view
    let viewState = {
        filter: 'all', // all, hazard, safe
        sort: 'size',  // size, speed, energy
        scaleMode: false // true = show comparison
    };

    // Physics Constants
    const DENSITY_ROCK = 2500; // kg/m^3 (Typical stony asteroid)
    
    // Helper: Calculate Kinetic Energy (Megatons of TNT)
    function calculateKineticEnergy(diameterM, velocityKph) {
        // 1. Mass (Volume * Density) - Assumes sphere
        const radius = diameterM / 2;
        const volume = (4/3) * Math.PI * Math.pow(radius, 3);
        const massKg = volume * DENSITY_ROCK;

        // 2. Velocity (km/h -> m/s)
        const velocityMs = velocityKph / 3.6;

        // 3. Energy (Joules) = 0.5 * m * v^2
        const energyJoules = 0.5 * massKg * Math.pow(velocityMs, 2);

        // 4. Convert to Megatons (1 MT = 4.184 x 10^15 J)
        const megatons = energyJoules / 4.184e15;
        
        return megatons;
    }

    // MAIN RENDER FUNCTION
    function render2DView(data) {
        const container = document.getElementById('data-view-container');
        container.innerHTML = ""; // Clear previous

        // --- A. HEADER & DESCRIPTION ---
        const header = document.createElement('div');
        header.className = 'analysis-header';
        header.innerHTML = `
            <h1 class="syne text-3xl text-white mb-2 uppercase">Target Analysis <span class="text-cyan-500">// Sector 7</span></h1>
            <p class="mono text-xs text-slate-400 leading-relaxed">
                <strong class="text-white">MODE: TECHNICAL ASSESSMENT.</strong> 
                Visualizing physical cross-sections vs. radar uncertainty range. 
                <br>
                <span class="text-cyan-500">‚ñ† OUTLINE:</span> Maximum possible diameter (Albedo limit).
                <span class="text-slate-500">‚ñ† CORE:</span> Minimum confirmed mass.
                <br>
                <span class="text-red-500">‚ö† IMPACT ENERGY:</span> Estimated kinetic yield in Megatons (MT) if impact occurs.
            </p>
        `;
        container.appendChild(header);

        // --- B. FILTER & SORT BAR ---
        const controls = document.createElement('div');
        controls.className = 'filter-bar';
        
        const buttons = [
            { text: 'ALL TARGETS', action: () => setFilter('all') },
            { text: 'HAZARDOUS ONLY', action: () => setFilter('hazard') },
            { text: 'SORT: SIZE', action: () => setSort('size') },
            { text: 'SORT: SPEED', action: () => setSort('speed') },
            { text: 'SORT: ENERGY', action: () => setSort('energy') },
            { text: 'TOGGLE SCALE REF', action: () => toggleScale() }
        ];

        buttons.forEach(btn => {
            const b = document.createElement('button');
            b.className = 'filter-btn';
            b.innerText = btn.text;
            b.onclick = (e) => {
                // Remove active class from siblings
                Array.from(controls.children).forEach(c => c.classList.remove('active'));
                b.classList.add('active');
                btn.action();
            };
            controls.appendChild(b);
        });
        container.appendChild(controls);

        // --- C. DATA PROCESSING ---
        // 1. Filter
        let displayData = data.filter(d => {
            if (viewState.filter === 'hazard') return d.hazardous;
            return true;
        });

        // 2. Sort
        displayData.sort((a, b) => {
            const energyA = calculateKineticEnergy(a.size_m, a.velocity_kph);
            const energyB = calculateKineticEnergy(b.size_m, b.velocity_kph);

            if (viewState.sort === 'size') return b.size_m - a.size_m;
            if (viewState.sort === 'speed') return b.velocity_kph - a.velocity_kph;
            if (viewState.sort === 'energy') return energyB - energyA;
            return 0;
        });

        // --- D. RENDER GRID ---
        const grid = document.createElement('div');
        grid.style.textAlign = "center";

        displayData.forEach(neo => {
            // Calculations
            let maxMeters = neo.size_m; 
            let minMeters = neo.raw_diameter_min || (maxMeters * 0.6); 
            const energy = calculateKineticEnergy(maxMeters, neo.velocity_kph);

            // Screen Scale (Clamped)
            const scale = 0.5; 
            const outerSize = Math.max(40, Math.min(300, maxMeters * scale)); 
            const innerSize = Math.max(10, Math.min(280, minMeters * scale));

            // Wrapper
            const wrapper = document.createElement('div');
            wrapper.className = `asteroid-2d hazard-${neo.hazardous}`;
            wrapper.style.width = `${outerSize}px`;
            wrapper.style.height = `${outerSize}px`;

            // 1. TAIL (Visualizing Velocity)
            // Length based on speed (Scale: 1000kph = 1px)
            const tailLen = Math.min(200, neo.velocity_kph / 500); 
            const tail = document.createElement('div');
            tail.className = 'velocity-tail';
            tail.style.width = `${outerSize + tailLen}px`;
            // Random rotation for "swarm" look, or fixed for "flow"
            const rot = Math.random() * 360;
            tail.style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;
            
            // 2. SHELL & CORE
            const shell = document.createElement('div');
            shell.className = 'asteroid-shell';
            const core = document.createElement('div');
            core.className = 'asteroid-core';
            core.style.width = `${innerSize}px`;
            core.style.height = `${innerSize}px`;

            // 3. HOVER LABEL (With Energy Stats)
            const label = document.createElement('div');
            label.className = 'asteroid-label';
            label.innerHTML = `
                <span class="text-cyan-400 font-bold">${neo.name}</span><br>
                DIA: ${Math.round(minMeters)}m - ${Math.round(maxMeters)}m<br>
                VEL: ${Math.round(neo.velocity_kph).toLocaleString()} km/h<br>
                <div class="impact-info text-${neo.hazardous ? 'red-400' : 'slate-400'}">
                    IMPACT YIELD: ${energy < 0.001 ? '<1 KT' : energy.toFixed(2) + ' MT'}
                </div>
            `;

            wrapper.appendChild(tail); // Add tail first (behind)
            wrapper.appendChild(shell);
            wrapper.appendChild(core);
            wrapper.appendChild(label);
            grid.appendChild(wrapper);
        });

        container.appendChild(grid);

        // --- E. SCALE REFERENCE (Eiffel Tower) ---
        if (viewState.scaleMode) {
            // Eiffel tower is ~330m. At scale 0.5, that is 165px.
            const ref = document.createElement('div');
            ref.style.position = 'fixed';
            ref.style.bottom = '20px';
            ref.style.right = '20px';
            ref.style.height = '165px'; // 330m * 0.5 scale
            ref.style.width = '40px';
            ref.style.borderRight = '2px dashed white';
            ref.style.borderBottom = '2px solid white';
            ref.innerHTML = "<div style='position:absolute; bottom:0; right:10px; color:white; font-size:10px; font-family:monospace; text-align:right;'>EIFFEL<br>TOWER<br>(330m)</div>";
            container.appendChild(ref);
        }
    }

    // UI Helper Functions
    function setFilter(type) {
        viewState.filter = type;
        render2DView(globalData);
    }
    function setSort(type) {
        viewState.sort = type;
        render2DView(globalData);
    }
    function toggleScale() {
        viewState.scaleMode = !viewState.scaleMode;
        render2DView(globalData);
    }

    function openAdminPrompt() {
        const uid = prompt("ENTER TARGET USER ID:");
        if(uid && currentUser) {
            fetch(`${API_URL}/community/approve`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ admin_id: currentUser.id, target_user_id: uid })
            }).then(res => res.json()).then(d => alert(JSON.stringify(d))).catch(e => alert(e));
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if(window.lucide) lucide.createIcons();
    });
    </script>
</body>
</html>